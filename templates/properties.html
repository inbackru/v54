{% extends "base.html" %}

{% block title %}Кэшбек за новостройки в Краснодаре до 500 000 ₽ | inback{% endblock %}
{% block description %}Как получить кэшбек 2,5-5% за новостройку? Пошаговая инструкция работы сервиса Inback. Официальный возврат при покупке квартиры в Краснодаре{% endblock %}
{% block keywords %}как получить кэшбек за квартиру, кэшбек за новостройку, возврат денег за квартиру, система кэшбека inback, оформление кэшбека, этапы получения кэшбека{% endblock %}

{% block extra_head %}
<!-- Robots meta -->
<meta name="robots" content="index, follow">

<!-- Open Graph / Facebook -->
<meta property="og:type" content="website">
<meta property="og:url" content="{{ url_for('properties', _external=True) }}">
<meta property="og:title" content="Кэшбек за новостройки в Краснодаре до 500 000 ₽ | InBack">
<meta property="og:description" content="Как получить кэшбек 2,5-5% за новостройку? Пошаговая инструкция работы сервиса InBack. Официальный возврат при покупке квартиры в Краснодаре">
<meta property="og:image" content="{{ url_for('static', filename='images/properties-og.jpg', _external=True) }}">
<meta property="og:site_name" content="InBack">
<meta property="og:locale" content="ru_RU">
<meta property="og:image:width" content="1200">
<meta property="og:image:height" content="630">

<!-- Twitter -->
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:url" content="{{ url_for('properties', _external=True) }}">
<meta name="twitter:title" content="Кэшбек за новостройки в Краснодаре до 500 000 ₽ | InBack">
<meta name="twitter:description" content="Официальный возврат денег за покупку квартиры в новостройке. Кэшбек 2,5-5% от стоимости жилья.">
<meta name="twitter:image" content="{{ url_for('static', filename='images/properties-og.jpg', _external=True) }}">
<!-- ⚡ КРИТИЧНО: Принудительное отключение кэша HTML -->
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate, max-age=0">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">

<link rel="canonical" href="{{ url_for('properties', _external=True) }}" />

<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position": 1,
      "name": "Главная",
      "item": "https://inback.ru"
    },
    {
      "@type": "ListItem",
      "position": 2,
      "name": "Новостройки",
      "item": "https://inback.ru/properties"
    }
  ]
}
</script>
<script src="https://api-maps.yandex.ru/2.1/?apikey={{ yandex_maps_api_key }}&lang=ru_RU" type="text/javascript"></script>
<style>
    /* Mobile-specific styles */
    @media (max-width: 640px) {
        /* Предотвращаем горизонтальный скролл */
        body {
            overflow-x: hidden !important;
            max-width: 100vw !important;
        }
        
        * {
            max-width: 100% !important;
        }
        
        .container, .max-w-7xl, main {
            overflow-x: hidden !important;
        }
        
        /* Мобильная карта */
        #propertiesMapContainer {
            border-radius: 0.75rem !important;
        }
        
        #propertiesMap {
            height: 400px !important;
        }
        
        #mapToggleBtn {
            flex-direction: column !important;
            gap: 0.5rem !important;
            padding: 1rem !important;
        }
        
        /* КРИТИЧНО: Карточки объектов - вертикальный layout на мобильных */
        .property-card {
            margin-bottom: 12px;
            flex-direction: column !important;
        }
        
        .property-card > div:first-child {
            width: 100% !important;
            height: 200px !important;
        }
        
        .property-card .carousel-container {
            height: 200px !important;
        }
        
        .property-card .carousel {
            height: 200px;
        }
        
        .property-card .carousel-item img {
            height: 200px;
            object-fit: cover;
            background: #f8f9fa;
        }
        
        .property-card .carousel-controls {
            display: none;
        }
        
        /* Контент карточки */
        .property-card > div:last-child {
            padding: 1rem !important;
        }
        
        /* Заголовок карточки */
        .property-card h2 {
            font-size: 1.125rem !important;
            margin-bottom: 0.5rem !important;
        }
        
        /* Теги */
        .property-card .flex.gap-2 {
            flex-wrap: wrap;
        }
        
        /* Кнопки действий */
        .property-card .flex.gap-2 button,
        .property-card .flex.gap-2 a {
            width: 36px !important;
            height: 36px !important;
        }
        
        /* Блок менеджера - компактный на мобильных */
        .manager-block {
            padding: 0.75rem !important;
        }
        
        .manager-block .flex {
            flex-direction: column;
            gap: 0.75rem !important;
        }
        
        .manager-block img {
            width: 48px !important;
            height: 48px !important;
        }
        
        .manager-block h3 {
            font-size: 1rem !important;
        }
        
        .manager-block p {
            font-size: 0.75rem !important;
            margin-bottom: 0.5rem !important;
        }
        
        .manager-block .flex.items-center.gap-4 {
            flex-direction: column;
            align-items: flex-start !important;
            gap: 0.5rem !important;
        }
        
        .manager-block .flex.items-center.gap-1 {
            font-size: 0.75rem !important;
        }
        
        /* ИСПРАВЛЕНО: Пагинация на мобильных - с правильным скопингом */
        .pagination-bar {
            flex-direction: column !important;
            gap: 1rem !important;
            align-items: flex-start !important;
        }
        
        .pagination-bar .text-sm,
        .pagination-bar > div {
            font-size: 0.75rem !important;
        }
        
        .pagination-bar .flex {
            width: 100% !important;
            flex-wrap: wrap !important;
            gap: 0.5rem !important;
        }
        
        .pagination-bar a,
        .pagination-bar span {
            font-size: 0.75rem !important;
            padding: 0.375rem 0.75rem !important;
        }
        
        .pagination-bar button {
            font-size: 0.75rem !important;
            padding: 0.375rem 0.75rem !important;
        }
        
        /* ИСПРАВЛЕНО: Фильтры - компактно на мобильных - с правильным скопингом */
        .filters-container {
            padding: 0.5rem !important;
        }
        
        .filters-container .flex.items-center.gap-3.text-sm {
            flex-wrap: wrap;
            gap: 0.5rem !important;
        }
        
        .filters-container .dropdown-btn {
            font-size: 0.75rem !important;
            padding: 0.375rem 0.5rem !important;
        }
        
        /* ИСПРАВЛЕНО: Toolbar (блок с результатами и кнопками) - с правильным скопингом */
        #properties-toolbar .flex.justify-between.items-center {
            flex-direction: column !important;
            gap: 0.75rem !important;
            align-items: flex-start !important;
        }
        
        #properties-toolbar h3 {
            font-size: 1rem !important;
        }
        
        #properties-toolbar .flex.gap-2 {
            width: 100%;
            flex-wrap: wrap;
            gap: 0.5rem !important;
        }
        
        #properties-toolbar button,
        #properties-toolbar select {
            font-size: 0.75rem !important;
            padding: 0.375rem 0.75rem !important;
        }
        
        /* ИСПРАВЛЕНО: Кнопка "На карте" - компактнее на мобильных - с правильным скопингом */
        #properties-toolbar .relative.rounded-2xl {
            min-width: auto !important;
            padding: 0.5rem !important;
        }
        
        #properties-toolbar .relative.rounded-2xl a {
            padding: 0.5rem 0.75rem !important;
            font-size: 0.75rem !important;
        }
        
        #properties-toolbar .relative.rounded-2xl svg {
            width: 1rem !important;
            height: 1rem !important;
        }
        
        /* ИСПРАВЛЕНО: View toggle buttons - с правильным скопингом */
        #properties-toolbar .flex.items-center.bg-gray-100 button {
            padding: 0.375rem 0.5rem !important;
            font-size: 0.75rem !important;
        }
        
        #properties-toolbar .flex.items-center.bg-gray-100 svg {
            width: 0.875rem !important;
            height: 0.875rem !important;
        }
    }

    /* Compact dropdown menu */
    .dropdown {
        position: relative;
        display: inline-block;
    }
    
    .dropdown-btn {
        background: transparent;
        border: none;
        color: #141A24;
        font-weight: 500;
        padding: 0.5rem 0.75rem;
        border-radius: 0.5rem;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        transition: all 0.2s;
        white-space: nowrap;
    }
    
    .dropdown-btn:hover {
        background: rgba(0, 136, 204, 0.1);
    }
    
    .dropdown-btn svg {
        width: 16px;
        height: 16px;
        transition: transform 0.2s;
    }
    
    .dropdown-btn.open svg {
        transform: rotate(180deg);
    }
    
    .dropdown-menu {
        position: absolute;
        top: calc(100% + 8px);
        left: 0;
        background: white;
        border-radius: 0.5rem;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1), 0 1px 3px rgba(0, 0, 0, 0.08);
        padding: 0.5rem 0;
        min-width: 200px;
        z-index: 50;
        opacity: 0;
        visibility: hidden;
        transform: translateY(-10px);
        transition: all 0.2s ease;
    }
    
    .dropdown-menu.open {
        opacity: 1;
        visibility: visible;
        transform: translateY(0);
    }
    
    .dropdown-menu .dropdown-section {
        padding: 0.5rem 1rem;
        border-bottom: 1px solid #f1f5f9;
    }
    
    .dropdown-menu .dropdown-section:last-child {
        border-bottom: none;
    }
    
    .dropdown-menu .dropdown-section h4 {
        font-size: 0.875rem;
        font-weight: 600;
        color: #64748b;
        margin-bottom: 0.5rem;
    }
    
    .dropdown-menu .filter-option {
        display: flex;
        align-items: center;
        padding: 0.375rem 0;
        font-size: 0.875rem;
        color: #374151;
        cursor: pointer;
        transition: color 0.2s;
    }
    
    .dropdown-menu .filter-option:hover {
        color: #0088CC;
    }
    
    .dropdown-menu .filter-option input[type="checkbox"] {
        margin-right: 0.5rem;
        width: 16px;
        height: 16px;
        accent-color: #0088CC;
    }
    
    .dropdown-menu .price-inputs {
        display: flex;
        gap: 0.5rem;
        padding: 0.5rem 1rem;
    }
    
    .dropdown-menu .price-inputs input {
        flex: 1;
        padding: 0.5rem;
        border: 1px solid #d1d5db;
        border-radius: 0.375rem;
        font-size: 0.875rem;
        outline: none;
    }
    
    .dropdown-menu .price-inputs input:focus {
        border-color: #0088CC;
        box-shadow: 0 0 0 2px rgba(0, 136, 204, 0.1);
    }
    
    .dropdown-menu .apply-price-btn {
        background: #0088CC;
        color: white;
        border: none;
        padding: 0.5rem 1rem;
        border-radius: 0.375rem;
        font-size: 0.875rem;
        cursor: pointer;
        margin: 0.5rem 1rem 0;
        transition: opacity 0.2s;
    }
    
    .dropdown-menu .apply-price-btn:hover {
        opacity: 0.9;
    }
    
    /* Active filter chips */
    .active-filter-chip {
        display: inline-flex;
        align-items: center;
        background: #0088CC;
        color: white;
        padding: 0.375rem 0.75rem;
        border-radius: 9999px;
        font-size: 0.875rem;
        gap: 0.5rem;
        margin: 0.25rem;
    }
    
    .active-filter-chip .remove-btn {
        width: 18px;
        height: 18px;
        background: rgba(255, 255, 255, 0.2);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        font-size: 14px;
        line-height: 1;
        transition: background 0.2s;
    }
    
    .active-filter-chip .remove-btn:hover {
        background: rgba(255, 255, 255, 0.3);
    }
    
    /* Beautiful Filter Button Styles */
    .filter-option-btn {
        transition: all 0.2s ease;
        border: 1px solid #e5e7eb;
        background: #f9fafb;
        position: relative;
    }

    .filter-option-btn:hover {
        background: #f3f4f6;
        border-color: #d1d5db;
        transform: translateY(-1px);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }

    .filter-option-btn:active {
        transform: translateY(0);
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
    }

    .filter-option-btn.active {
        background: #eff6ff;
        border-color: #3b82f6;
        color: #1d4ed8;
    }

    .filter-option-btn.active svg {
        color: #3b82f6;
    }

    /* Quick Filter Dropdown Styles */
    .dropdown {
        position: relative;
        display: inline-block;
    }

    .dropdown-btn {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .dropdown-menu {
        position: absolute;
        top: 100%;
        left: 0;
        background: white;
        border: 1px solid #d1d5db;
        border-radius: 0.5rem;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        z-index: 1000;
        min-width: 200px;
        padding: 0.5rem;
        margin-top: 0.25rem;
        opacity: 0;
        visibility: hidden;
        transform: translateY(-10px);
        transition: all 0.2s ease;
    }
    
    .dropdown-menu.open {
        opacity: 1;
        visibility: visible;
        transform: translateY(0);
    }

    .dropdown-menu.open {
        opacity: 1;
        visibility: visible;
        transform: translateY(0);
    }

    .dropdown-item {
        display: flex;
        align-items: center;
        padding: 0.5rem;
        border-radius: 0.25rem;
        cursor: pointer;
        transition: background-color 0.15s;
        font-size: 0.875rem;
    }

    .dropdown-item:hover {
        background-color: #f3f4f6;
    }

    /* Filter counter badge */
    .filter-counter {
        background: #ef4444;
        color: white;
        font-size: 0.75rem;
        font-weight: 600;
        min-width: 18px;
        height: 18px;
        border-radius: 50%;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        margin-left: 0.5rem;
    }
    
    /* Toggle switches */
    .toggle-checkbox:checked {
        right: 0;
        border-color: #0088CC;
        background-color: #0088CC;
    }
    
    .toggle-checkbox:checked + .toggle-label {
        background-color: #0088CC;
    }
    
    .toggle-label {
        transition: background-color 0.2s;
    }
    
    /* Hide unsupported advanced filters based on user feedback */
    .filter-dropdown[data-filter="property_class"],
    .filter-dropdown[data-filter="wall_material"],
    .filter-dropdown[data-filter="floors_total"],
    .filter-dropdown[data-filter="window_view"],
    .filter-dropdown[data-filter="cardinal_direction"],
    .filter-dropdown[data-filter="apartment_category"],
    .filter-dropdown[data-filter="entrance_access"],
    .filter-dropdown[data-filter="panoramic"],
    .filter-dropdown[data-filter="developer_pv"],
    .filter-dropdown[data-filter="mortgage_types"],
    .filter-dropdown[data-filter="escrow"],
    .filter-dropdown[data-filter="property_rights_cost"],
    .filter-dropdown[data-filter="direction"],
    .filter-dropdown[data-filter="registration"],
    .filter-dropdown[data-filter="nearby_places"] {
        display: none !important;
    }
    
    /* Hide sections if they become empty */
    .space-y-3:has(.filter-dropdown:not([style*="display: none"]):only-child) {
        min-height: 100px;
    }
    
    /* Hide specific quick filter buttons by unique selectors */
    button[data-filter="distance"]:not(:only-child) {
        /* Keep "До центра" - it's supported */
    }
    
    /* More specific approach: manually hide unsupported buttons by finding parent containers */
    /* This will be handled by JavaScript after page load for better compatibility */
    
    /* Manager Favorites Styles */
    .manager-favorite-heart {
        transition: all 0.3s ease;
        background: rgba(0, 136, 204, 0.9) !important;
    }
    
    .manager-favorite-heart:hover {
        background: #0088CC !important;
        transform: scale(1.1);
        box-shadow: 0 4px 12px rgba(0, 136, 204, 0.3);
    }
    
    .manager-favorite-heart i {
        color: white !important;
        font-size: 14px;
    }
    
    .manager-favorite-heart.manager-favorited {
        background: #0088CC !important;
        box-shadow: 0 0 0 2px white, 0 0 0 4px #0088CC;
    }
    
    .manager-favorite-heart.manager-favorited i {
        color: #FFD700 !important;
        animation: heartbeat 1.5s ease-in-out infinite;
    }
    
    .manager-favorite-heart.pulse-blue {
        animation: pulse-blue 1.5s ease-in-out infinite;
    }
    
    .manager-favorite-heart.animate-click {
        transform: scale(0.85);
        transition: transform 0.15s ease-out;
    }
    
    /* Blue pulse animation for manager hearts */
    @keyframes pulse-blue {
        0% {
            box-shadow: 0 0 0 0 rgba(0, 136, 204, 0.4);
        }
        70% {
            box-shadow: 0 0 0 10px rgba(0, 136, 204, 0);
        }
        100% {
            box-shadow: 0 0 0 0 rgba(0, 136, 204, 0);
        }
    }
    
    /* Heartbeat animation for favorited manager stars */
    @keyframes heartbeat {
        0%, 50%, 100% {
            transform: scale(1);
        }
        25%, 75% {
            transform: scale(1.2);
        }
    }
    
    /* Floating stars animation for manager favorites */
    .floating-star {
        position: fixed;
        pointer-events: none;
        z-index: 9999;
        animation: float-up-star 2s ease-out forwards;
        font-size: 14px;
        color: #0088CC;
        text-shadow: 0 0 6px rgba(0, 136, 204, 0.8);
    }
    
    @keyframes float-up-star {
        0% {
            opacity: 1;
            transform: translateY(0) scale(0.8);
        }
        50% {
            opacity: 1;
            transform: translateY(-30px) scale(1.2);
        }
        100% {
            opacity: 0;
            transform: translateY(-60px) scale(0.6);
        }
    }
    
    /* Ensure proper spacing between favorite buttons */
    .favorite-heart {
        transition: all 0.3s ease;
    }
    
    .favorite-heart:hover {
        transform: scale(1.1);
        box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
    }
    
    .favorite-heart.favorited {
        box-shadow: 0 0 0 2px white, 0 0 0 4px #ef4444;
    }
    
    .favorite-heart.animate-click {
        transform: scale(0.85);
        transition: transform 0.15s ease-out;
    }
    
    /* Improve button container layout */
    .absolute.top-3.right-3.flex.gap-2 {
        right: 12px !important;
    }
    
    /* Manager AND User Comparison Styles - Using BRAND BLUE (same as favorites) */
    .compare-btn {
        transition: all 0.3s ease;
    }
    
    /* Both manager and user comparison highlighting use BLUE color */
    .compare-btn.manager-comparison-active,
    .compare-btn.user-comparison-active {
        background: linear-gradient(135deg, #0088CC 0%, #0066AA 100%) !important;
        border-color: #0088CC !important;
        box-shadow: 0 0 0 2px white, 0 0 0 4px #0088CC !important;
    }
    
    .compare-btn.manager-comparison-active i,
    .compare-btn.user-comparison-active i {
        color: white !important;
        animation: scalebeat 1.5s ease-in-out infinite;
    }
    
    .compare-btn.pulse-blue {
        animation: pulse-blue 1.5s ease-in-out infinite;
    }
    
    .compare-btn.animate-click {
        transform: scale(0.85);
        transition: transform 0.15s ease-out;
    }
    
    /* Scale beat animation for comparison icons */
    @keyframes scalebeat {
        0%, 50%, 100% {
            transform: scale(1);
        }
        25%, 75% {
            transform: scale(1.2);
        }
    }
</style>
{% endblock %}

{% block breadcrumbs %}
<!-- Breadcrumbs -->
<div class="container mx-auto px-4 py-3 text-sm">
    <nav class="flex" aria-label="Breadcrumb">
        <ol class="inline-flex items-center space-x-1 md:space-x-3">
            <li class="inline-flex items-center">
                <a href="{{ url_for('index') }}" class="text-[#0088CC] hover:underline inline-flex items-center">
                    <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20"><path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z"></path></svg>
                    Главная
                </a>
            </li>
            <li aria-current="page">
                <div class="flex items-center">
                    <svg class="w-6 h-6 text-gray-400" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path></svg>
                    <span class="text-gray-500 ml-1 md:ml-2">Поиск объектов</span>
                </div>
            </li>
        </ol>
    </nav>
</div>
{% endblock %}

{% block content %}
<!-- Hidden CSRF token for AJAX requests -->
<form style="display: none;">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
</form>

<!-- Advanced Search Form -->
<section id="properties" class="py-20 bg-white">
    <div class="container mx-auto px-4">
        <h2 class="text-3xl md:text-4xl font-bold text-center mb-6">Найдите идеальную квартиру в Краснодаре</h2>
        <p class="text-xl text-gray-600 text-center mb-12">Найдите идеальную квартиру в Краснодаре по вашим параметрам</p>
    </div>
</section>

<!-- Search Block -->
<section class="py-8 bg-gray-50">
    <div class="container mx-auto px-4">
        <!-- Enhanced Smart Search Bar -->
        <div class="bg-white rounded-lg shadow-md border border-gray-200 p-4 mb-4">
            <!-- Search Input Row -->
            <div class="flex flex-col lg:flex-row gap-3 items-center">
                <!-- Enhanced Search Input -->
                <div class="flex-1 relative">
                    <input type="text" 
                           id="property-search"
                           placeholder="Умный поиск: район, застройщик, ЖК, тип квартиры..." 
                           class="w-full pl-4 pr-4 py-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-[#0088CC] focus:border-blue-500 outline-none transition-all text-gray-700">
                    <!-- ✅ УДАЛЕНО: Enhanced Search Suggestions - SuperSearch создает свой dropdown -->
                    <!-- <div id="property-searchSuggestions" ...> ОТКЛЮЧЕН </div> -->
                </div>
                <!-- Search Results Info -->
                <div class="text-sm text-gray-500">
                    Поиск с подсказками
                </div>
            </div>
        </div>

        <!-- Quick Filters -->
        <div class="filters-container bg-white rounded-lg shadow-sm border border-gray-200 p-3">
            <div class="flex items-center gap-3 text-sm">
                <div class="text-gray-600 whitespace-nowrap font-medium">Быстрые фильтры</div>
                
                <!-- Quick Filter Buttons -->
                <div class="flex flex-wrap gap-2">
                    <!-- Room Type Filter -->
                    <div class="dropdown" data-filter="rooms">
                        <button class="dropdown-btn border border-gray-300 px-3 py-1.5 rounded text-sm hover:bg-gray-50 flex items-center gap-1" onclick="this.parentElement.querySelector('.dropdown-menu').classList.toggle('open')">
                            <span id="roomsFilterText">Комнат</span>
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                            </svg>
                        </button>
                        <div class="dropdown-menu">
                            <label class="dropdown-item">
                                <input type="checkbox" value="0" data-filter-type="rooms" class="mr-2" onchange="handleRoomFilterChange()" {% if '0' in filters.rooms %}checked{% endif %}> Студия
                            </label>
                            <label class="dropdown-item">
                                <input type="checkbox" value="1" data-filter-type="rooms" class="mr-2" onchange="handleRoomFilterChange()" {% if '1' in filters.rooms %}checked{% endif %}> 1-комнатная
                            </label>
                            <label class="dropdown-item">
                                <input type="checkbox" value="2" data-filter-type="rooms" class="mr-2" onchange="handleRoomFilterChange()" {% if '2' in filters.rooms %}checked{% endif %}> 2-комнатная
                            </label>
                            <label class="dropdown-item">
                                <input type="checkbox" value="3" data-filter-type="rooms" class="mr-2" onchange="handleRoomFilterChange()" {% if '3' in filters.rooms %}checked{% endif %}> 3-комнатная
                            </label>
                            <label class="dropdown-item">
                                <input type="checkbox" value="4" data-filter-type="rooms" class="mr-2" onchange="handleRoomFilterChange()" {% if '4' in filters.rooms %}checked{% endif %}> 4-комнатная
                            </label>
                        </div>
                    </div>
                    
                    <!-- Price Filter -->
                    <div class="dropdown" data-filter="price">
                        <button class="dropdown-btn border border-gray-300 px-3 py-1.5 rounded text-sm hover:bg-gray-50 flex items-center gap-1" onclick="this.parentElement.querySelector('.dropdown-menu').classList.toggle('open')">
                            <span id="priceFilterText">Цена</span>
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                            </svg>
                        </button>
                        <div class="dropdown-menu" style="min-width: 280px;">
                            <div class="p-3">
                                <div class="grid grid-cols-2 gap-3">
                                    <div>
                                        <label class="text-xs text-gray-600 mb-1 block">От, млн ₽</label>
                                        <input type="number" id="priceFrom" placeholder="1" min="0" step="0.1" class="w-full px-2 py-1 border border-gray-300 rounded text-sm">
                                    </div>
                                    <div>
                                        <label class="text-xs text-gray-600 mb-1 block">До, млн ₽</label>
                                        <input type="number" id="priceTo" placeholder="20" min="0" step="0.1" class="w-full px-2 py-1 border border-gray-300 rounded text-sm">
                                    </div>
                                </div>
                                <button onclick="applyPriceFilter()" class="w-full bg-[#0088CC] text-white py-2 rounded mt-3 text-sm hover:opacity-90">Применить</button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Developer Filter -->
                    <div class="dropdown" data-filter="developers">
                        <button class="dropdown-btn border border-gray-300 px-3 py-1.5 rounded text-sm hover:bg-gray-50 flex items-center gap-1" onclick="this.parentElement.querySelector('.dropdown-menu').classList.toggle('open')">
                            <span id="developerFilterText">Застройщик</span>
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                            </svg>
                        </button>
                        <div class="dropdown-menu">
                            {% if developers %}
                                {% for developer in developers %}
                                <label class="dropdown-item">
                                    <input type="checkbox" value="{{ developer.id }}" data-filter-type="developer" data-developer-name="{{ developer.name }}" class="mr-2" onchange="updateAdvancedFiltersCounter();" {% if developer.id|string in filters.get("developers", [])|map('string')|list %}checked{% endif %}> {{ developer.name }}
                                </label>
                                {% endfor %}
                            {% else %}
                                <label class="dropdown-item">
                                    <input type="checkbox" value="1" data-filter-type="developer" data-developer-name="ГК Неометрия" class="mr-2" onchange="updateAdvancedFiltersCounter();"> ГК Неометрия
                                </label>
                            {% endif %}
                        </div>
                    </div>
                    
                    <!-- Completion Date Filter -->
                    <div class="dropdown" data-filter="completion">
                        <button class="dropdown-btn border border-gray-300 px-3 py-1.5 rounded text-sm hover:bg-gray-50 flex items-center gap-1" onclick="this.parentElement.querySelector('.dropdown-menu').classList.toggle('open')">
                            <span id="completionFilterText">Сдача</span>
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                            </svg>
                        </button>
                        <div class="dropdown-menu">
                            <label class="dropdown-item">
                                <input type="checkbox" value="2024" data-filter-type="completion" class="mr-2" onchange="updateAdvancedFiltersCounter();"> 2024
                            </label>
                            <label class="dropdown-item">
                                <input type="checkbox" value="2025" data-filter-type="completion" class="mr-2" onchange="updateAdvancedFiltersCounter();"> 2025
                            </label>
                            <label class="dropdown-item">
                                <input type="checkbox" value="2026" data-filter-type="completion" class="mr-2" onchange="updateAdvancedFiltersCounter();"> 2026
                            </label>
                            <label class="dropdown-item">
                                <input type="checkbox" value="2028" data-filter-type="completion" class="mr-2" onchange="updateAdvancedFiltersCounter();"> 2028
                            </label>
                        </div>
                    </div>
                    
                    <!-- Modern Advanced Filters -->
                    <button id="advancedFiltersToggle" class="dropdown-btn border border-gray-300 px-3 py-1.5 rounded-lg text-sm hover:bg-gray-50 flex items-center gap-1 relative transition-all duration-200 hover:border-[#0088CC] group">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5 text-gray-500 group-hover:text-[#0088CC]" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 100 4m0-4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 100 4m0-4v2m0-6V4" />
                        </svg>
                        <span class="font-medium">Еще</span>
                        <div id="advancedFiltersCounter" class="hidden absolute -top-1 -right-1 bg-gradient-to-r from-[#0088CC] to-[#006699] text-white text-xs font-bold rounded-full w-5 h-5 flex items-center justify-center shadow-lg">0</div>
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 ml-1 transition-transform duration-200 group-hover:rotate-180" fill="none" viewBox="0 0 24 24" stroke="currentColor" id="advancedFiltersArrow">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                        </svg>
                    </button>
                    
                    <!-- Search Button -->
                    <button id="applyFiltersBtn" onclick="applyFilters()" class="px-4 py-1.5 bg-gradient-to-r from-[#0088CC] to-[#006699] text-white font-medium rounded hover:from-[#006699] hover:to-[#004477] transition-all duration-300 shadow-sm hover:shadow-md whitespace-nowrap text-sm">
                        <i class="fas fa-search mr-1"></i>
                        Найти
                    </button>
                    
                    <!-- Map Button -->
                    <a href="/map" class="flex items-center justify-center px-4 py-1.5 bg-white text-[#0088CC] border border-[#0088CC] font-medium rounded hover:bg-[#0088CC] hover:text-white transition-all duration-300 shadow-sm hover:shadow-md whitespace-nowrap text-sm">
                        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7"></path>
                        </svg>
                        На карте
                    </a>

                    <!-- Save Search Button -->
                    <div class="relative">
                        <button id="saveSearchBtn" class="flex items-center px-4 py-1.5 bg-white border border-gray-300 text-gray-700 rounded hover:bg-gray-50 transition-all duration-300 whitespace-nowrap text-sm shadow-sm" title="Сохранить поиск">
                            <i class="fas fa-heart mr-2 text-[#FF6B6B]"></i>
                            Сохранить поиск
                        </button>
                        
                        <!-- Save Search Dropdown -->
                        <div id="saveSearchDropdown" class="hidden absolute top-full left-0 mt-1 bg-white border border-gray-200 rounded-lg shadow-lg z-50 min-w-72">
                            <div class="p-3">
                                <div class="mb-3">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Название поиска</label>
                                    <input type="text" id="searchNameInput" placeholder="Название поиска" class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm focus:ring-[#0088CC] focus:border-[#0088CC]">
                                </div>
                                
                                {% if is_manager %}
                                <div class="mb-3">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Email клиента (опционально)</label>
                                    <input type="email" id="clientEmailInput" placeholder="client@example.com" class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm focus:ring-[#0088CC] focus:border-[#0088CC]">
                                    <p class="text-xs text-gray-500 mt-1">Если указан, поиск будет отправлен клиенту</p>
                                </div>
                                {% endif %}
                                
                                <div class="flex gap-2">
                                    <button id="saveSearchConfirmBtn" class="flex-1 px-3 py-2 bg-[#0088CC] text-white rounded-md text-sm hover:bg-[#0077BB] transition">
                                        Сохранить
                                    </button>
                                    <button id="saveSearchCancelBtn" class="px-3 py-2 border border-gray-300 rounded-md text-sm hover:bg-gray-50 transition">
                                        Отмена
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Results Counter -->
                    <div class="text-gray-600 px-3 py-1.5 whitespace-nowrap text-sm">
                        <span id="resultsCounter" class="font-medium">{{ pagination.total }} объектов</span>
                    </div>
                </div>
                

            </div>
            
            <!-- ✅ ИСПРАВЛЕН: Блок активных фильтров с правильными ID -->
            <div id="active-filters-container" class="hidden bg-gradient-to-r from-blue-50 to-indigo-50 rounded-lg shadow-sm border border-blue-200 p-3 mt-4">
                <div class="flex flex-wrap items-center gap-3">
                    <span class="text-sm font-medium text-gray-700 flex items-center">
                        <i class="fas fa-filter text-blue-600 mr-2"></i>
                        Активные фильтры:
                    </span>
                    <div id="active-filters-list" class="flex flex-wrap gap-2">
                        <!-- Active filters will be inserted here by JavaScript -->
                    </div>
                    <button id="clearAllFilters" class="text-sm bg-gray-100 hover:bg-gray-200 text-gray-600 px-3 py-1.5 rounded-lg border border-gray-200 transition-all font-medium" onclick="console.log('✅ ОЧИСТИТЬ ВСЕ - перенаправляем на /properties'); window.location.href='/properties'; return false;">
                        Сбросить все
                    </button>
                </div>
            </div>
            
            <!-- Advanced Filters Panel -->
            <div id="advancedFiltersPanel" class="hidden mt-6 bg-white rounded-xl shadow-lg border border-gray-100 overflow-hidden">
                <div class="bg-gradient-to-r from-gray-50 to-white border-b border-gray-200 px-6 py-4">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-[#0088CC] mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 100 4m0-4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 100 4m0-4v2m0-6V4" />
                            </svg>
                            <h3 class="text-lg font-semibold text-gray-800">Расширенные фильтры</h3>
                            <span class="ml-2 px-2 py-1 bg-blue-100 text-blue-800 text-xs font-medium rounded-full">Pro</span>
                        </div>
                        <button id="closeAdvancedFilters" class="text-gray-400 hover:text-gray-600 transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                            </svg>
                        </button>
                    </div>
                </div>
                
                <div class="p-6">
                    <div class="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-4 gap-6">
                        
                        <!-- Параметры недвижимости -->
                        <div class="space-y-4 min-w-0">
                            <h4 class="font-semibold text-gray-800 flex items-center border-b border-gray-200 pb-2">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2 text-[#0088CC]" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2H5a2 2 0 00-2-2z" />
                                </svg>
                                Параметры
                            </h4>
                            
                            <!-- Площадь -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Площадь, м²</label>
                                <div class="flex gap-2">
                                    <input type="number" id="areaFrom" placeholder="от" class="w-20 px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-[#0088CC] focus:border-transparent transition-all">
                                    <input type="number" id="areaTo" placeholder="до" class="w-20 px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-[#0088CC] focus:border-transparent transition-all">
                                </div>
                            </div>
                            
                            <!-- Этаж -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Этаж</label>
                                <div class="flex gap-2">
                                    <input type="number" id="floorFrom" placeholder="от" class="w-20 px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-[#0088CC] focus:border-transparent transition-all">
                                    <input type="number" id="floorTo" placeholder="до" class="w-20 px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-[#0088CC] focus:border-transparent transition-all">
                                </div>
                            </div>
                            
                            <!-- Максимальный этаж -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Этажность дома</label>
                                <div class="flex gap-2">
                                    <input type="number" id="maxFloorFrom" placeholder="от" class="w-20 px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-[#0088CC] focus:border-transparent transition-all">
                                    <input type="number" id="maxFloorTo" placeholder="до" class="w-20 px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-[#0088CC] focus:border-transparent transition-all">
                                </div>
                            </div>
                        </div>
                        
                        <!-- Характеристики -->
                        <div class="space-y-4 min-w-0">
                            <h4 class="font-semibold text-gray-800 flex items-center border-b border-gray-200 pb-2">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2 text-[#0088CC]" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                                Характеристики
                            </h4>
                            
                            <!-- Класс недвижимости -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Класс недвижимости</label>
                                <div class="space-y-2">
                                    <label class="flex items-center hover:bg-gray-50 p-2 rounded-lg transition-colors cursor-pointer">
                                        <input type="checkbox" value="Бизнес" data-filter-type="object_class" class="text-[#0088CC] focus:ring-[#0088CC] border-gray-300 rounded" onchange="updateAdvancedFiltersCounter();" {% if "Бизнес" in filters.get("object_classes", []) %}checked{% endif %}>
                                        <span class="ml-2 text-sm text-gray-700">Бизнес</span>
                                    </label>
                                    <label class="flex items-center hover:bg-gray-50 p-2 rounded-lg transition-colors cursor-pointer">
                                        <input type="checkbox" value="Комфорт" data-filter-type="object_class" class="text-[#0088CC] focus:ring-[#0088CC] border-gray-300 rounded" onchange="updateAdvancedFiltersCounter();" {% if "Комфорт" in filters.get("object_classes", []) %}checked{% endif %}>
                                        <span class="ml-2 text-sm text-gray-700">Комфорт</span>
                                    </label>
                                    <label class="flex items-center hover:bg-gray-50 p-2 rounded-lg transition-colors cursor-pointer">
                                        <input type="checkbox" value="Премиум" data-filter-type="object_class" class="text-[#0088CC] focus:ring-[#0088CC] border-gray-300 rounded" onchange="updateAdvancedFiltersCounter();" {% if "Премиум" in filters.get("object_classes", []) %}checked{% endif %}>
                                        <span class="ml-2 text-sm text-gray-700">Премиум</span>
                                    </label>
                                </div>
                            </div>
                            
                            <!-- Отделка -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Отделка</label>
                                <div class="space-y-2">
                                    <label class="flex items-center hover:bg-gray-50 p-2 rounded-lg transition-colors cursor-pointer">
                                        <input type="checkbox" value="no_renovation" data-filter-type="renovation" class="text-[#0088CC] focus:ring-[#0088CC] border-gray-300 rounded" onchange="updateAdvancedFiltersCounter();" {% if 'no_renovation' in filters.renovation %}checked{% endif %}>
                                        <span class="ml-2 text-sm text-gray-700">Без отделки</span>
                                    </label>
                                    <label class="flex items-center hover:bg-gray-50 p-2 rounded-lg transition-colors cursor-pointer">
                                        <input type="checkbox" value="with_renovation" data-filter-type="renovation" class="text-[#0088CC] focus:ring-[#0088CC] border-gray-300 rounded" onchange="updateAdvancedFiltersCounter();" {% if 'with_renovation' in filters.renovation %}checked{% endif %}>
                                        <span class="ml-2 text-sm text-gray-700">Чистовая</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Дополнительные условия -->
                        <div class="space-y-4 min-w-0">
                            <h4 class="font-semibold text-gray-800 flex items-center border-b border-gray-200 pb-2">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2 text-[#0088CC]" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1" />
                                </svg>
                                Условия
                            </h4>
                            
                            <!-- Ипотека и финансы -->
                            <div class="space-y-2">
                                <label class="flex items-center hover:bg-gray-50 p-2 rounded-lg transition-colors cursor-pointer">
                                    <input type="checkbox" value="accreditation" data-filter-type="features" class="text-[#0088CC] focus:ring-[#0088CC] border-gray-300 rounded" onchange="updateAdvancedFiltersCounter();">
                                    <span class="ml-2 text-sm text-gray-700">Аккредитация банков</span>
                                </label>
                                <label class="flex items-center hover:bg-gray-50 p-2 rounded-lg transition-colors cursor-pointer">
                                    <input type="checkbox" value="green_mortgage" data-filter-type="features" class="text-[#0088CC] focus:ring-[#0088CC] border-gray-300 rounded" onchange="updateAdvancedFiltersCounter();">
                                    <span class="ml-2 text-sm text-gray-700">Льготная ипотека</span>
                                </label>
                                <label class="flex items-center hover:bg-gray-50 p-2 rounded-lg transition-colors cursor-pointer">
                                    <input type="checkbox" value="government_program" data-filter-type="features" class="text-[#0088CC] focus:ring-[#0088CC] border-gray-300 rounded" onchange="updateAdvancedFiltersCounter();">
                                    <span class="ml-2 text-sm text-gray-700">Господдержка</span>
                                </label>
                                <label class="flex items-center hover:bg-gray-50 p-2 rounded-lg transition-colors cursor-pointer">
                                    <input type="checkbox" value="trade_in" data-filter-type="features" class="text-[#0088CC] focus:ring-[#0088CC] border-gray-300 rounded" onchange="updateAdvancedFiltersCounter();">
                                    <span class="ml-2 text-sm text-gray-700">Trade-in</span>
                                </label>
                            </div>
                        </div>
                        
                        <!-- Расположение и дата -->
                        <div class="space-y-4 min-w-0">
                            <h4 class="font-semibold text-gray-800 flex items-center border-b border-gray-200 pb-2">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2 text-[#0088CC]" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                                </svg>
                                Расположение
                            </h4>
                            
                            <!-- Год сдачи -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Год сдачи</label>
                                <div class="flex gap-2">
                                    <input type="number" id="buildYearFrom" placeholder="от" class="w-20 px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-[#0088CC] focus:border-transparent transition-all" onchange="updateAdvancedFiltersCounter();">
                                    <input type="number" id="buildYearTo" placeholder="до" class="w-20 px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-[#0088CC] focus:border-transparent transition-all" onchange="updateAdvancedFiltersCounter();">
                                </div>
                            </div>
                            
                            <!-- Статус сдачи -->
                            <div class="space-y-2">
                                <label class="flex items-center hover:bg-gray-50 p-2 rounded-lg transition-colors cursor-pointer">
                                    <input type="checkbox" value="true" data-filter-type="building_released" class="text-[#0088CC] focus:ring-[#0088CC] border-gray-300 rounded" onchange="updateAdvancedFiltersCounter();" {% if "true" in filters.get("building_released", []) %}checked{% endif %}>
                                    <span class="ml-2 text-sm text-gray-700">Сданный дом</span>
                                </label>
                                <label class="flex items-center hover:bg-gray-50 p-2 rounded-lg transition-colors cursor-pointer">
                                    <input type="checkbox" value="false" data-filter-type="building_released" class="text-[#0088CC] focus:ring-[#0088CC] border-gray-300 rounded" onchange="updateAdvancedFiltersCounter();" {% if "false" in filters.get("building_released", []) %}checked{% endif %}>
                                    <span class="ml-2 text-sm text-gray-700">В строительстве</span>
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Action Buttons -->
                    <div class="mt-8 pt-6 border-t border-gray-200">
                        <div class="flex gap-3 justify-end">
                            <button id="resetAdvancedFilters" onclick="resetAdvancedFilters(); applyFilters();" class="px-6 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-all duration-200 font-medium">
                                Сбросить
                            </button>
                            <button id="applyAdvancedFilters" onclick="applyFilters();" class="px-8 py-2 bg-gradient-to-r from-[#0088CC] to-[#006699] text-white rounded-lg hover:from-[#006699] hover:to-[#004477] transition-all duration-300 shadow-lg hover:shadow-xl font-medium flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                                </svg>
                                Применить фильтры
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
    

<!-- Main Content Section -->
<section class="container mx-auto px-4 py-6">
    <div class="w-full mx-auto">
        <!-- Mini Map Section (Avito-style) -->
        <div class="mb-6 bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
            <!-- Mini Map Preview -->
            <div id="miniPropertiesMap" class="w-full relative" style="height: 200px; cursor: pointer;" onclick="window.location.href='/map'">
                <div class="absolute inset-0 bg-gradient-to-br from-blue-50 to-blue-100 flex items-center justify-center">
                    <div class="text-center">
                        <svg class="w-16 h-16 mx-auto text-[#0088CC] opacity-50 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                        </svg>
                        <p class="text-sm text-gray-600">Загрузка карты...</p>
                    </div>
                </div>
            </div>
            
            <!-- Map Link Button -->
            <a href="/map" class="block p-4 border-t border-gray-200 hover:bg-gray-50 transition-colors">
                <div class="flex items-center justify-center gap-3">
                    <svg class="w-5 h-5 text-[#0088CC]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7"></path>
                    </svg>
                    <span class="font-semibold text-gray-900">Показать объявления на карте</span>
                    <span class="px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-sm font-medium">{{ total_properties or 0 }}</span>
                </div>
            </a>
        </div>

        <!-- Results Header -->
        <div id="properties-toolbar" class="bg-white rounded-xl shadow-sm border border-gray-200 p-4 mb-6">
            <div class="flex justify-between items-center">
                <h3 class="text-xl font-bold text-gray-900">
                    {% if results_text %}
                        {{ results_text }}
                    {% else %}
                        Найдено <span id="results-count">{{ total_properties or 0 }}</span> 
                        {% set count = total_properties or 0 %}
                        {% if count % 100 in [11, 12, 13, 14] %}объектов
                        {% elif count % 10 == 1 %}объект
                        {% elif count % 10 in [2, 3, 4] %}объекта
                        {% else %}объектов{% endif %}
                    {% endif %}
                </h3>
                <div class="flex gap-2">
                    <button onclick="openApplicationModal()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors flex items-center gap-2 text-sm">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
                        </svg>
                        Связаться
                    </button>
                    <select id="sort-select" class="border border-gray-300 rounded-lg px-3 py-2 text-sm">
                        <option value="" disabled selected>Сортировать</option>
                        <option value="price-desc">По цене ↓</option>
                        <option value="price-asc">По цене ↑</option>
                        <option value="area-desc">По площади ↓</option>
                        <option value="area-asc">По площади ↑</option>
                        <option value="date-desc">По дате</option>
                    </select>
                    
                    <!-- View Toggle -->
                    <div class="flex items-center bg-gray-100 rounded-lg p-1">
                        <button id="list-view-btn" onclick="switchToListView()" class="flex items-center gap-1 px-3 py-2 rounded-md text-sm font-medium transition-colors bg-white text-gray-900 shadow-sm">
                            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M3 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM3 10a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM3 16a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z"/>
                            </svg>
                            Список
                        </button>
                        <button id="grid-view-btn" onclick="switchToGridView()" class="flex items-center gap-1 px-3 py-2 rounded-md text-sm font-medium transition-colors text-gray-600 hover:text-gray-900">
                            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M5 3a2 2 0 00-2 2v2a2 2 0 002 2h2a2 2 0 002-2V5a2 2 0 00-2-2H5zM5 11a2 2 0 00-2 2v2a2 2 0 002 2h2a2 2 0 002-2v-2a2 2 0 00-2-2H5zM11 5a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V5zM11 13a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"/>
                            </svg>
                            Сетка
                        </button>
                    </div>
                    
                    <!-- Map CTA with Enhanced Background -->
                    <div class="relative rounded-2xl overflow-hidden p-3" style="background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 50%, #90caf9 100%); min-width: 160px;">
                        <!-- Enhanced SVG Map Pattern Background -->
                        <svg class="absolute inset-0 w-full h-full" xmlns="http://www.w3.org/2000/svg">
                            <defs>
                                <pattern id="map-grid" x="0" y="0" width="30" height="30" patternUnits="userSpaceOnUse">
                                    <path d="M0 15 L30 15 M15 0 L15 30" stroke="#1976d2" stroke-width="0.5" fill="none" opacity="0.2"/>
                                </pattern>
                            </defs>
                            <rect width="100%" height="100%" fill="url(#map-grid)"/>
                            <!-- Map roads/streets -->
                            <path d="M5,10 Q25,8 45,15 T85,18 L95,20" stroke="#1976d2" stroke-width="2" fill="none" opacity="0.25"/>
                            <path d="M10,25 Q30,23 50,30 T90,33 L100,35" stroke="#1976d2" stroke-width="2" fill="none" opacity="0.25"/>
                            <path d="M8,40 Q28,38 48,45 T88,48" stroke="#1976d2" stroke-width="1.5" fill="none" opacity="0.2"/>
                            <!-- Map markers -->
                            <circle cx="30" cy="12" r="2" fill="#e91e63" opacity="0.4"/>
                            <circle cx="60" cy="28" r="2" fill="#e91e63" opacity="0.4"/>
                            <circle cx="45" cy="42" r="2" fill="#e91e63" opacity="0.4"/>
                        </svg>
                        
                        <!-- Prominent Map Button -->
                        <a href="{{ url_for('map_view') }}" class="relative z-10 flex items-center justify-center gap-2 bg-white hover:bg-gray-50 text-gray-900 font-semibold px-5 py-2.5 rounded-xl shadow-md hover:shadow-lg transition-all duration-200">
                            <svg class="w-5 h-5 text-[#1976d2]" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/>
                            </svg>
                            <span class="text-sm">На карте</span>
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>


<!-- Properties Cards Section -->
<section class="py-8 bg-white">
    <div class="container mx-auto px-4">
        <div class="bg-gray-50 rounded-xl shadow-md border border-gray-200 p-6">

                <!-- Property Cards -->
                <div id="properties-container" class="space-y-6">
                    {% if properties and properties|length > 0 %}
                    {% for property in properties[:20] %}
                    
                    {% if loop.index0 > 0 and loop.index0 % 6 == 0 %}
                    <!-- Manager Block between properties -->
                    <div class="manager-block bg-gray-100 rounded-lg p-4 border border-gray-200 shadow-sm relative" id="manager-block-server-{{ loop.index0 }}">
                        <button class="absolute top-3 right-3 text-gray-400 hover:text-gray-600 transition-colors" onclick="this.parentElement.style.display='none';" title="×">
                            <i class="fas fa-times"></i>
                        </button>
                        <div class="flex items-center gap-4">
                            <div class="flex-shrink-0">
                                {% if manager and manager.photo %}
                                <img src="{{ manager.photo }}" alt="{{ manager.name }}" class="w-16 h-16 rounded object-cover">
                                {% elif manager %}
                                <div class="w-16 h-16 rounded bg-blue-600 flex items-center justify-center text-white text-sm font-bold">
                                    {{ manager.name.split()[0][0] }}{{ manager.name.split()[1][0] if manager.name.split()|length > 1 else '' }}
                                </div>
                                {% else %}
                                <div class="w-16 h-16 rounded bg-blue-600 flex items-center justify-center text-white text-xl">
                                    <i class="fas fa-building"></i>
                                </div>
                                {% endif %}
                                <div class="bg-blue-600 text-white text-xs px-2 py-1 rounded mt-1 text-center font-medium">{{ 'Менеджер' if manager else 'InBack' }}</div>
                            </div>
                            <div class="flex-1">
                                <h3 class="text-lg font-semibold text-gray-900 mb-1">{{ manager.name if manager else 'InBack' }}</h3>
                                <p class="text-gray-600 text-sm mb-3">Получите бесплатную помощь {{ 'от вашего менеджера' if manager else 'от нашей команды' }} по покупке новостройки</p>
                                <div class="flex items-center gap-4 text-sm">
                                    <div class="flex items-center gap-1 text-blue-600">
                                        <i class="fas fa-phone text-xs"></i>
                                        <span>{{ manager.phone if manager else '8 (862) 266-62-16' }}</span>
                                    </div>
                                    <div class="flex items-center gap-1 text-blue-600">
                                        <i class="fas fa-envelope text-xs"></i>
                                        <span>{{ manager.email if manager else 'info@inback.ru' }}</span>
                                    </div>
                                </div>
                            </div>
                            <div class="flex-shrink-0">
                                <button onclick="openApplicationModal()" class="bg-blue-600 text-white px-4 py-2 rounded text-sm font-medium hover:bg-blue-700 transition">
                                    <i class="fas fa-comments mr-1"></i>
                                    Связаться
                                </button>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    <!-- Property Card - Exact Screenshot Design -->
                    <div class="property-card bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden w-full cursor-pointer" 
                         data-property-url="{{ url_for('property_detail', property_id=property.id) }}" 
                         data-type="{{ property.type }}" 
                         data-rooms="{{ property.rooms }}" 
                         data-price="{{ property.price }}" 
                         data-district="{{ property.district }}" 
                         data-developer="{{ property.developer }}"
                         data-complex="{{ property.residential_complex or 'Не указан' }}"
                         data-property-type="{{ property.property_type or property.type }}"
                         data-completion="{{ property.completion_date or '2024' }}"
                         data-area="{{ property.area }}"
                         data-floor="{{ property.floor }}"
                         data-mortgage="{{ property.mortgage_available|default('true') }}"
                         data-installment="{{ property.installment_available|default('false') }}"
                         data-maternal-capital="{{ property.maternal_capital|default('false') }}"
                         data-trade-in="{{ property.trade_in|default('false') }}"
                         data-cashback="{{ property.cashback_available|default('true') }}">
                        
                        <!-- Image Section with Slider -->
                        <div class="relative w-80 h-60 flex-shrink-0 group">
                            <div class="carousel-container w-full h-60 relative overflow-hidden bg-gray-100 rounded-lg" data-property-id="{{ property.id }}">
                                <!-- Image slides -->
                                {% if property.gallery and property.gallery|length > 0 %}
                                    {% for image in property.gallery[:4] %}
                                    <div class="carousel-slide absolute inset-0 {% if loop.index0 > 0 %}opacity-0{% endif %} transition-opacity duration-300" data-slide="{{ loop.index0 }}">
                                        <img src="{{ image }}" 
                                             alt="{% if property.rooms == 0 %}Студия{% else %}{{ property.rooms }}-комн{% endif %} {{ property.area }} м² - фото {{ loop.index }}" 
                                             class="w-full h-full object-cover" 
                                             loading="lazy">
                                    </div>
                                    {% endfor %}
                                {% else %}
                                    <div class="carousel-slide absolute inset-0 transition-opacity duration-300" data-slide="0">
                                        <img src="{{ property.image or 'https://via.placeholder.com/320x280/f3f4f6/9ca3af?text=Фото+недоступно' }}" 
                                             alt="{% if property.rooms == 0 %}Студия{% else %}{{ property.rooms }}-комн{% endif %} {{ property.area }} м²" 
                                             class="w-full h-full object-cover" 
                                             loading="lazy">
                                    </div>
                                {% endif %}
                                
                                <!-- Navigation arrows -->
                                {% if property.gallery and property.gallery|length > 1 %}
                                <button onclick="event.stopPropagation(); event.preventDefault(); prevImageSlide(this, event); return false;" class="absolute left-2 top-1/2 -translate-y-1/2 w-8 h-8 bg-black/50 hover:bg-black/70 text-white rounded-full flex items-center justify-center transition-all opacity-0 group-hover:opacity-100 z-10 slider-prev-btn">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                                    </svg>
                                </button>
                                <button onclick="event.stopPropagation(); event.preventDefault(); nextImageSlide(this, event); return false;" class="absolute right-2 top-1/2 -translate-y-1/2 w-8 h-8 bg-black/50 hover:bg-black/70 text-white rounded-full flex items-center justify-center transition-all opacity-0 group-hover:opacity-100 z-10 slider-next-btn">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                                    </svg>
                                </button>
                                
                                <!-- Dots indicator -->
                                <div class="absolute bottom-3 left-1/2 -translate-x-1/2 flex gap-1.5 opacity-0 group-hover:opacity-100 transition-opacity z-10">
                                    {% set gallery_length = property.gallery|length if property.gallery else 1 %}
                                    {% set max_slides = [gallery_length, 4]|min %}
                                    {% for i in range(max_slides) %}
                                    <button onclick="event.stopPropagation(); event.preventDefault(); goToImageSlide(this, {{ i }}, event); return false;" class="slider-dot-btn w-2.5 h-2.5 rounded-full {% if i == 0 %}bg-white/80{% else %}bg-white/50{% endif %} hover:bg-white transition-colors" data-slide="{{ i }}"></button>
                                    {% endfor %}
                                </div>
                                {% endif %}
                            </div>
                            
                            <!-- Blue Cashback Badge -->
                            <div class="absolute top-3 left-3 bg-blue-600 text-white text-xs font-medium px-2 py-1 rounded z-20">
                                Кэшбек до {{ "{:,.0f}".format(property.cashback or 0) }} ₽
                            </div>
                            
                            <!-- Favorite Icons Container -->
                            <div class="absolute top-3 right-3 flex gap-2 z-20">
                                <!-- Universal Heart Icon -->
                                <div class="w-8 h-8 bg-white/90 hover:bg-white rounded-full flex items-center justify-center shadow cursor-pointer favorite-heart z-20" data-property-id="{{ property.id }}" title="Добавить в избранное" onclick="if(window.favoritesManager) { window.favoritesManager.toggleFavorite('{{ property.id }}', this); event.stopPropagation(); }">
                                    <i class="fas fa-heart text-gray-400 hover:text-red-500 text-sm transition-colors"></i>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Content Section -->
                        <div class="flex-1 p-6 flex flex-col">
                            <!-- Title -->
                            <h2 class="text-xl font-semibold text-gray-900 mb-3">
                                {% if property.rooms == 0 %}Студия{% else %}{{ property.rooms }}-комн{% endif %}, {{ property.area }} м², {{ property.floor }}/{{ property.total_floors }} эт.
                            </h2>
                            
                            <!-- Complex and Location -->
                            <div class="mb-2">
                                {% if property.residential_complex or property.complex_name %}
                                <a href="/residential-complex/{{ property.residential_complex or property.complex_name }}" 
                                   class="text-blue-600 hover:text-blue-700 hover:underline text-sm font-medium" onclick="event.stopPropagation();">
                                    {{ property.residential_complex or property.complex_name }}
                                </a>
                                {% else %}
                                <span class="text-gray-700 text-sm font-medium">
                                    ЖК не указан
                                </span>
                                {% endif %}
                                <span class="text-blue-600 text-sm"> • Краснодарский край</span>
                            </div>
                            
                            <!-- Address -->
                            <div class="text-gray-500 text-sm mb-2">
                                {{ property.address or 'Россия, Краснодарский край, Сочи, Кудепста м-н, Искра, 88 лит7' }}
                            </div>
                            
                            <!-- Developer -->
                            <div class="text-gray-700 text-sm mb-4">
                                <span class="font-medium">Застройщик:</span> {{ property.developer or property.developer_name or 'ГК Неометрия' }}
                            </div>
                            
                            <!-- Tags -->
                            <div class="flex gap-2 mb-4">
                                <span class="bg-gray-100 text-gray-700 px-2 py-1 rounded text-xs">{{ property.floor }}-й этаж</span>
                                <span class="bg-gray-100 text-gray-700 px-2 py-1 rounded text-xs">{{ property.renovation_display_name or 'Без отделки' }}</span>
                                <span class="bg-gray-100 text-gray-700 px-2 py-1 rounded text-xs">{{ property.complex_object_class_display_name or 'Комфорт' }}</span>
                            </div>
                            
                            <div class="flex-1"></div>
                            
                            
                            <!-- Action Buttons Row with Price and Mortgage Info -->
                            <div class="flex items-center justify-between">
                                <div class="flex flex-col gap-2">
                                    {% if property.price and property.price > 0 %}
                                    <div class="text-2xl font-bold text-gray-900">
                                        {{ "{:,.0f}".format(property.price) }} ₽
                                    </div>
                                    <div class="bg-green-100 text-green-800 text-xs px-2 py-1 rounded">
                                        от {{ "{:,.0f}".format((property.price * 0.05) // 12) }} ₽/мес ипотека
                                    </div>
                                    {% else %}
                                    <div class="text-2xl font-bold text-gray-900">
                                        Цена по запросу
                                    </div>
                                    {% endif %}
                                </div>
                                <div class="flex gap-2">
                                    <a href="{{ url_for('property_pdf', property_id=property.id) }}" target="_blank" 
                                       class="w-10 h-10 bg-white border border-gray-300 rounded flex items-center justify-center text-gray-600 hover:bg-blue-50 hover:border-blue-300 hover:text-blue-600 hover:scale-105 transition-all duration-200" 
                                       title="Скачать PDF" onclick="event.stopPropagation();">
                                        <i class="fas fa-file-pdf"></i>
                                    </a>
                                    <button class="compare-btn w-10 h-10 bg-white border border-gray-300 rounded flex items-center justify-center text-gray-600 hover:bg-blue-50 hover:border-blue-300 hover:text-blue-600 hover:scale-105 transition-all duration-200" 
                                            data-property-id="{{ property.id }}" title="Добавить к сравнению">
                                        <i class="fas fa-balance-scale"></i>
                                    </button>
                                    {% if is_manager %}
                                    <button class="presentation-btn w-10 h-10 bg-white border border-purple-300 rounded flex items-center justify-center text-purple-600 hover:bg-purple-50 hover:border-purple-400 hover:text-purple-700 hover:scale-105 transition-all duration-200" 
                                            data-property-id="{{ property.id }}" title="Добавить в презентацию" onclick="window.openPresentationModal('{{ property.id }}'); event.stopPropagation();">
                                        <i class="fas fa-plus"></i>
                                    </button>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                    {% else %}
                    <!-- Empty State - No Properties Found -->
                    <div class="flex flex-col items-center justify-center py-16 px-4">
                        <div class="text-center max-w-md">
                            <!-- Icon -->
                            <div class="mb-6">
                                <svg class="w-24 h-24 mx-auto text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                                </svg>
                            </div>
                            
                            <!-- Message -->
                            <h3 class="text-2xl font-bold text-gray-800 mb-3">Объекты не найдены</h3>
                            <p class="text-gray-600 mb-6">К сожалению, по вашему запросу не найдено подходящих объектов. Попробуйте изменить параметры поиска или сбросить все фильтры.</p>
                            
                            <!-- Actions -->
                            <div class="flex flex-col sm:flex-row gap-3 justify-center">
                                <button onclick="window.location.href='/properties';" class="bg-[#0088CC] hover:bg-[#006699] text-white px-6 py-3 rounded-lg font-medium transition-all">
                                    <i class="fas fa-redo mr-2"></i>
                                    Сбросить фильтры
                                </button>
                                <button onclick="openApplicationModal()" class="bg-white hover:bg-gray-50 text-gray-700 border border-gray-300 px-6 py-3 rounded-lg font-medium transition-all">
                                    <i class="fas fa-phone mr-2"></i>
                                    Связаться с нами
                                </button>
                            </div>
                            
                            <!-- Suggestions -->
                            <div class="mt-8 pt-8 border-t border-gray-200">
                                <p class="text-sm text-gray-500 mb-3">Попробуйте:</p>
                                <div class="flex flex-wrap gap-2 justify-center">
                                    <a href="/properties?rooms=1" class="text-sm bg-gray-100 hover:bg-gray-200 text-gray-700 px-3 py-1.5 rounded-full transition-all">1-комнатные</a>
                                    <a href="/properties?rooms=2" class="text-sm bg-gray-100 hover:bg-gray-200 text-gray-700 px-3 py-1.5 rounded-full transition-all">2-комнатные</a>
                                    <a href="/properties?price_max=5" class="text-sm bg-gray-100 hover:bg-gray-200 text-gray-700 px-3 py-1.5 rounded-full transition-all">До 5 млн ₽</a>
                                    <a href="/map-view" class="text-sm bg-gray-100 hover:bg-gray-200 text-gray-700 px-3 py-1.5 rounded-full transition-all">Посмотреть на карте</a>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>

                <!-- JavaScript Pagination Container -->
                <div id="pagination-container"></div>

                <!-- Серверная пагинация включена для изначального отображения -->
                {% if pagination and pagination.total_pages > 1 %}
                <div class="pagination-bar flex justify-between items-center bg-white rounded-lg shadow-sm border border-gray-200 p-4 mt-6">
                    <div class="text-sm text-gray-600">
                        Показано <span class="font-semibold">{{ (pagination.page - 1) * pagination.per_page + 1 }}-{{ pagination.page * pagination.per_page if pagination.page * pagination.per_page <= pagination.total else pagination.total }}</span> 
                        из <span class="font-semibold">{{ pagination.total }}</span> объектов
                    </div>
                    
                    <div class="flex space-x-2">
                        <!-- Предыдущая страница -->
                        {% if pagination.has_prev %}
                            <a href="?page={{ pagination.prev_page }}{% for key, value in request.args.items() %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}" 
                               class="px-3 py-2 border rounded-lg hover:bg-gray-50 transition">
                                Предыдущая
                            </a>
                        {% else %}
                            <span class="px-3 py-2 border rounded-lg text-gray-400 cursor-not-allowed">Предыдущая</span>
                        {% endif %}
                        
                        <!-- Номера страниц -->
                        {% set start_page = [pagination.page - 2, 1]|max %}
                        {% set end_page = [pagination.page + 2, pagination.total_pages]|min %}
                        
                        {% if start_page > 1 %}
                            <a href="?page=1{% for key, value in request.args.items() %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}" 
                               class="px-3 py-2 border rounded-lg hover:bg-gray-50 transition">1</a>
                            {% if start_page > 2 %}
                                <span class="px-2">...</span>
                            {% endif %}
                        {% endif %}
                        
                        {% for page_num in range(start_page, end_page + 1) %}
                            {% if page_num == pagination.page %}
                                <span class="px-3 py-2 border rounded-lg bg-[#0088CC] text-white">{{ page_num }}</span>
                            {% else %}
                                <a href="?page={{ page_num }}{% for key, value in request.args.items() %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}" 
                                   class="px-3 py-2 border rounded-lg hover:bg-gray-50 transition">{{ page_num }}</a>
                            {% endif %}
                        {% endfor %}
                        
                        {% if end_page < pagination.total_pages %}
                            {% if end_page < pagination.total_pages - 1 %}
                                <span class="px-2">...</span>
                            {% endif %}
                            <a href="?page={{ pagination.total_pages }}{% for key, value in request.args.items() %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}" 
                               class="px-3 py-2 border rounded-lg hover:bg-gray-50 transition">{{ pagination.total_pages }}</a>
                        {% endif %}
                        
                        <!-- Следующая страница -->
                        {% if pagination.has_next %}
                            <a href="?page={{ pagination.next_page }}{% for key, value in request.args.items() %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}" 
                               class="px-3 py-2 border rounded-lg hover:bg-gray-50 transition">
                                Следующая
                            </a>
                        {% else %}
                            <span class="px-3 py-2 border rounded-lg text-gray-400 cursor-not-allowed">Следующая</span>
                        {% endif %}
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</section>

<!-- Call-to-Action Section -->
<section class="py-8 bg-white">
    <div class="container mx-auto px-4">
        <div class="bg-gray-50 rounded-xl shadow-md border border-gray-200 p-6">
            <div class="text-center mb-6">
                <h2 class="text-xl font-semibold text-gray-900 mb-2">
                    Получите персональную подборку квартир
                </h2>
                <p class="text-sm text-gray-600">
                    Наши эксперты подберут лучшие варианты с максимальным кэшбеком
                </p>
            </div>
            
            <div class="bg-white rounded-lg border border-gray-200 p-4">
                <div class="flex flex-col sm:flex-row gap-3 mb-3">
                    <input type="text" placeholder="Ваше имя" class="flex-1 px-3 py-2 border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 focus:border-blue-500 outline-none text-sm">
                    <input type="tel" placeholder="+7 (900) 123-45-67" class="flex-1 px-3 py-2 border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 focus:border-blue-500 outline-none text-sm">
                    <select class="flex-1 px-3 py-2 border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 focus:border-blue-500 outline-none text-sm">
                        <option>Выберите бюджет</option>
                        <option>До 3 млн ₽</option>
                        <option>3-5 млн ₽</option>
                        <option>5-8 млн ₽</option>
                        <option>8-12 млн ₽</option>
                        <option>Свыше 12 млн ₽</option>
                    </select>
                </div>
                
                <div class="flex flex-col sm:flex-row gap-3 items-center">
                    <button onclick="openApplicationModal();" class="w-full sm:w-auto px-6 py-2 bg-blue-600 text-white font-medium rounded hover:bg-blue-700 transition-colors text-sm">
                        Получить подборку
                    </button>
                    <p class="text-xs text-gray-500">
                        Бесплатно • Персональные предложения
                    </p>
                </div>
            </div>
        </div>
    </div>
</section>

<script>
console.log('🚨 ЭКСТРЕННЫЙ SCRIPT ЗАПУЩЕН!');

// ✅ ЭКСТРЕННАЯ КНОПКА СБРОСА ФИЛЬТРОВ
window.TOTAL_RESET = function() {
    console.log('🔥 TOTAL_RESET АКТИВИРОВАН - СБРОС ВСЕГО!');
    
    // Убираем все фильтры из URL
    const newUrl = '/properties';
    console.log('🔄 Перенаправляем на:', newUrl);
    window.location.href = newUrl;
};

// ✅ Экстренная кнопка больше не нужна - функциональность встроена в обычную кнопку
console.log('✅ Функция TOTAL_RESET готова для использования');

// ===== IMAGE SLIDER FUNCTIONS =====
function nextImageSlide(button, event) {
    if (event) {
        event.stopPropagation();
        event.preventDefault();
    }
    
    const carousel = button.closest('.carousel-container');
    const slides = carousel.querySelectorAll('.carousel-slide');
    const dots = carousel.parentElement.querySelectorAll('.absolute.bottom-3 button');
    
    let currentSlide = 0;
    slides.forEach((slide, index) => {
        if (!slide.classList.contains('opacity-0')) {
            currentSlide = index;
        }
    });
    
    const nextSlide = (currentSlide + 1) % slides.length;
    
    slides[currentSlide].classList.add('opacity-0');
    slides[nextSlide].classList.remove('opacity-0');
    
    if (dots.length > 0) {
        dots[currentSlide].classList.remove('bg-white/80');
        dots[currentSlide].classList.add('bg-white/50');
        dots[nextSlide].classList.remove('bg-white/50');
        dots[nextSlide].classList.add('bg-white/80');
    }
    return false;
}

function prevImageSlide(button, event) {
    if (event) {
        event.stopPropagation();
        event.preventDefault();
    }
    
    const carousel = button.closest('.carousel-container');
    const slides = carousel.querySelectorAll('.carousel-slide');
    const dots = carousel.parentElement.querySelectorAll('.absolute.bottom-3 button');
    
    let currentSlide = 0;
    slides.forEach((slide, index) => {
        if (!slide.classList.contains('opacity-0')) {
            currentSlide = index;
        }
    });
    
    const prevSlide = currentSlide === 0 ? slides.length - 1 : currentSlide - 1;
    
    slides[currentSlide].classList.add('opacity-0');
    slides[prevSlide].classList.remove('opacity-0');
    
    if (dots.length > 0) {
        dots[currentSlide].classList.remove('bg-white/80');
        dots[currentSlide].classList.add('bg-white/50');
        dots[prevSlide].classList.remove('bg-white/50');
        dots[prevSlide].classList.add('bg-white/80');
    }
    return false;
}

function goToImageSlide(button, slideIndex, event) {
    if (event) {
        event.stopPropagation();
        event.preventDefault();
    }
    
    const carousel = button.closest('.absolute').previousElementSibling;
    const slides = carousel.querySelectorAll('.carousel-slide');
    const dots = button.parentElement.querySelectorAll('button');
    
    slides.forEach((slide, index) => {
        if (index === slideIndex) {
            slide.classList.remove('opacity-0');
        } else {
            slide.classList.add('opacity-0');
        }
    });
    
    dots.forEach((dot, index) => {
        if (index === slideIndex) {
            dot.classList.remove('bg-white/50');
            dot.classList.add('bg-white/80');
        } else {
            dot.classList.remove('bg-white/80');
            dot.classList.add('bg-white/50');
        }
    });
    return false;
}

// Make slider functions globally available for inline handlers
window.nextImageSlide = nextImageSlide;
window.prevImageSlide = prevImageSlide;
window.goToImageSlide = goToImageSlide;

// ✅ ИСПРАВЛЕНИЕ: Глобальная функция для инициализации carousel event listeners
// Вызывается при загрузке страницы И после AJAX обновления списка
window.initializeImageCarousels = function() {
    console.log('🎠 Initializing image carousels...');
    
    // Remove old listeners to avoid duplicates
    const prevBtns = document.querySelectorAll('.slider-prev-btn');
    const nextBtns = document.querySelectorAll('.slider-next-btn');
    const dotBtns = document.querySelectorAll('.slider-dot-btn');
    
    console.log('🎠 Found carousel controls:', {
        prevBtns: prevBtns.length,
        nextBtns: nextBtns.length,
        dotBtns: dotBtns.length
    });
    
    // Previous slide buttons
    prevBtns.forEach(btn => {
        // Clone and replace to remove old listeners
        const newBtn = btn.cloneNode(true);
        btn.parentNode.replaceChild(newBtn, btn);
        
        newBtn.addEventListener('click', function(e) {
            e.stopPropagation();
            e.preventDefault();
            prevImageSlide(this, e);
        });
    });
    
    // Next slide buttons
    nextBtns.forEach(btn => {
        const newBtn = btn.cloneNode(true);
        btn.parentNode.replaceChild(newBtn, btn);
        
        newBtn.addEventListener('click', function(e) {
            e.stopPropagation();
            e.preventDefault();
            nextImageSlide(this, e);
        });
    });
    
    // Dot buttons
    dotBtns.forEach(btn => {
        const newBtn = btn.cloneNode(true);
        btn.parentNode.replaceChild(newBtn, btn);
        
        newBtn.addEventListener('click', function(e) {
            e.stopPropagation();
            e.preventDefault();
            const slideIndex = parseInt(this.dataset.slide);
            goToImageSlide(this, slideIndex, e);
        });
    });
    
    console.log('✅ Image carousels initialized');
};

console.log('✅ Carousel functions loaded and available globally');



// Set authentication status immediately at the start
window.user_authenticated = {{ user_authenticated|tojson|safe }};
window.manager_authenticated = {{ manager_authenticated|tojson|safe }};
window.isManager = {{ manager_authenticated|tojson|safe }};
{% if current_manager %}
window.current_manager = {{ current_manager.to_dict()|tojson|safe }};
{% else %}
window.current_manager = null;
{% endif %}

// User's assigned manager data for properties page
{% if manager %}
window.userManager = {{ manager|tojson|safe }};
{% else %}
window.userManager = null;
{% endif %}

// ⚡ VERSION MARKER: v1761503218
console.log('🔥🔥🔥 PROPERTIES.HTML VERSION: v1761503218 - LOADED! 🔥🔥🔥');

// Debug authentication status
console.log('Authentication status:', {
    user_authenticated: window.user_authenticated,
    manager_authenticated: window.manager_authenticated,
    current_manager: window.current_manager || null
});

let map;
let markers = [];

// Properties already filtered and paginated by server
let allProperties = {{ properties|tojson|safe }};
let filteredProperties = allProperties; // Don't re-filter on client
// Note: window.serverSidePagination, totalProperties, totalPages set in extra_head block

let selectedRooms = new Set();
let currentSortBy = 'price-desc';
let currentPage = {{ page }};
window.itemsPerPage = 20;
let residentialComplexes = [];

// Completely remove old favorites system - now handled by FavoritesManager
// Clear localStorage to avoid conflicts
if (localStorage.getItem('favorites')) {
    localStorage.removeItem('favorites');
    console.log('Cleared old localStorage favorites');
}

// Favorites counter is now handled by FavoritesManager class
// function updateFavoritesCounter() - DEPRECATED

// Advanced Filters Object
let advancedFilters = {
    districts: [],
    developers: [],
    propertyTypes: [],
    priceMin: 0,
    priceMax: 0,
    roomTypes: [],
    distances: [],
    areas: [],
    directions: [],
    payments: [],
    areaFrom: 0,
    areaTo: 0
};

// Add galleries to properties for testing
allProperties.forEach((property, index) => {
    if (!property.gallery) {
        property.gallery = [
            property.image,
            `https://via.placeholder.com/400x300/FF5722/FFFFFF?text=Кухня`,
            `https://via.placeholder.com/400x300/4CAF50/FFFFFF?text=Спальня`,
            `https://via.placeholder.com/400x300/9C27B0/FFFFFF?text=Вид`
        ];
    }
});

// ✅ sortProperties теперь загружается из внешнего файла /static/js/properties-sorting.js

// Initialize smart autocomplete search for properties catalog
function initializePropertiesSmartSearch() {
    const searchInput = document.getElementById('property-search');
    if (!searchInput) return;
    
    // Make the input container relative
    searchInput.parentElement.style.position = 'relative';
    
    // Initialize smart autocomplete
    const autocomplete = new SmartAutocomplete(searchInput, {
        placeholder: 'Поиск по адресу, ЖК, застройщику...',
        onSelect: function(suggestion) {
            console.log('🎯 SmartAutocomplete onSelect called:', suggestion);
            handlePropertiesSearchSelection(suggestion);
        },
        onSearch: function(query, suggestion) {
            console.log('🔍 SmartAutocomplete onSearch called:', query, suggestion);
            performPropertiesSmartSearch(query, suggestion);
        }
    });
    
    // Store reference globally
    window.propertiesAutocomplete = autocomplete;
}

// ✅ ДОБАВЛЕНО: Глобальный обработчик для SuperSearch
window.handlePropertySuggestionSelect = function(suggestion) {
    console.log('🎯 Properties selected suggestion:', suggestion);
    handlePropertiesSearchSelection(suggestion);
};

// Handle search suggestion selection for properties
function handlePropertiesSearchSelection(suggestion) {
    console.log('🏷️ Handling suggestion:', suggestion);
    
    // ✅ ИСПРАВЛЕНИЕ: Если есть URL, просто переходим по нему
    if (suggestion.url) {
        console.log('🔗 Navigating to URL:', suggestion.url);
        window.location.href = suggestion.url;
        return;
    }
    
    // Fallback - обрабатываем локально
    switch(suggestion.type) {
        case 'address':
            document.getElementById('property-search').value = suggestion.text;
            applyFilters();
            break;
        case 'complex':
            // ✅ ИСПРАВЛЕНО: Устанавливаем фильтр по ЖК
            console.log('🏗️ Setting complex filter:', suggestion.text);
            activeFilters.residential_complex = suggestion.text;
            if (window.activeFilters) {
                window.activeFilters.residential_complex = suggestion.text;
            }
            // Очищаем поисковую строку, т.к. фильтр теперь в activeFilters.residential_complex
            document.getElementById('property-search').value = '';
            applyFilters();
            console.log('✅ Complex filter applied:', activeFilters.residential_complex);
            break;
        case 'developer':
            // ✅ ИСПРАВЛЕНО: Устанавливаем фильтр по застройщику
            console.log('🏢 Setting developer filter:', suggestion.text);
            const developerSelect = document.getElementById('developer-filter');
            if (developerSelect) {
                const option = Array.from(developerSelect.options).find(opt => 
                    opt.textContent.toLowerCase().includes(suggestion.text.toLowerCase())
                );
                if (option) {
                    developerSelect.value = option.value;
                    console.log('✅ Developer filter set to:', option.value);
                } else {
                    console.warn('⚠️ Developer not found in select:', suggestion.text);
                }
            }
            document.getElementById('property-search').value = '';
            applyFilters();
            break;
        case 'district':
            const districtSelect = document.getElementById('district-filter');
            if (districtSelect) {
                const option = Array.from(districtSelect.options).find(opt => 
                    opt.textContent.toLowerCase().includes(suggestion.text.toLowerCase())
                );
                if (option) {
                    districtSelect.value = option.value;
                }
            }
            applyFilters();
            break;
        case 'rooms':
            // Handle room type suggestions
            if (suggestion.text.includes('Студи')) {
                document.querySelector('input[value="0"]')?.click();
            } else if (suggestion.text.includes('1-комнат')) {
                document.querySelector('input[value="1"]')?.click();
            } else if (suggestion.text.includes('2-комнат')) {
                document.querySelector('input[value="2"]')?.click();
            } else if (suggestion.text.includes('3-комнат')) {
                document.querySelector('input[value="3"]')?.click();
            }
            break;
        default:
            document.getElementById('property-search').value = suggestion.text;
            applyFilters();
    }
}

// Smart search for properties catalog
function performPropertiesSmartSearch(query, suggestion) {
    console.log('Performing properties smart search:', query, suggestion);
    document.getElementById('property-search').value = query;
    applyFilters();
}

// Enhanced search functionality with comprehensive suggestions for ALL parameters
function initializeSearch() {
    // Legacy function - replaced with smart search
    initializePropertiesSmartSearch();
    
    const searchInput = document.getElementById('property-search');
    const suggestionsContainer = document.getElementById('property-searchSuggestions');
    
    // Create comprehensive search suggestions covering ALL filter types with REAL database data
    const suggestions = {
        districts: ['Краснодарский край'],
        rooms: ['Студия', '1-комнатная', '2-комнатная', '3-комнатная', '4-комнатная'],
        propertyClass: ['Эконом', 'Комфорт', 'Бизнес', 'Премиум'],
        wallMaterial: ['Кирпич', 'Монолит', 'Панель', 'Газобетон'],
        floorsTotal: ['до 5 этажей', '6-10 этажей', '11-20 этажей', 'более 20 этажей'],
        completion: ['2024', '2025', '2026', '2028'],
        developers: ['ГК Неометрия', 'AVA', 'ЦЕНТРАЛЬНАЯ ИНВЕСТИЦИОННАЯ КОМПАНИЯ', 'СЗ КАСКАД', 'ТОЧНО', 'СПЕЦИАЛИЗИРОВАННЫЙ ЗАСТРОЙЩИК КОРОНА'],
        complexes: ['ЖК Гостиничный комплекс "Нескучный сад"', 'ЖК Лестория', 'ЖК ФЛОРА', 'ЖК "Кислород"', 'ЖК "Чайные холмы"', 'ЖК Гостиничный комплекс "Гранд Каскад"'],
        properties: [],
        streets: []
    };
    
    // Add property and complex data
    allProperties.forEach(property => {
        const propertyTitle = property.rooms == 0 ? 'Студия' : property.rooms + '-комн';
        suggestions.properties.push(propertyTitle + ' ' + property.area + ' м²');
        suggestions.complexes.push(property.residential_complex);
        suggestions.developers.push(property.developer);
        suggestions.streets.push(property.location);
    });
    
    // Add ЖК suggestions
    residentialComplexes.forEach(complex => {
        suggestions.complexes.push(complex.name);
        suggestions.developers.push(complex.developer);
        suggestions.streets.push(complex.location);
    });
    
    // Remove duplicates from each category
    Object.keys(suggestions).forEach(key => {
        suggestions[key] = [...new Set(suggestions[key])].filter(Boolean);
    });
    
    const allSuggestions = Object.values(suggestions).flat();
    
    searchInput.addEventListener('input', function() {
        const query = this.value.toLowerCase().trim();
        
        if (query.length < 2) {
            if (suggestionsContainer) {
                suggestionsContainer.classList.add('hidden');
            }
            return;
        }
        
        // Filter both property and ЖК suggestions
        const propertySuggestions = uniqueSuggestions
            .filter(suggestion => suggestion.toLowerCase().includes(query))
            .slice(0, 5);
            
        const complexSuggestions = residentialComplexes
            .filter(complex => 
                complex.name.toLowerCase().includes(query) ||
                complex.developer.toLowerCase().includes(query) ||
                complex.location.toLowerCase().includes(query)
            )
            .slice(0, 3);
        
        let suggestionHTML = '';
        
        if (propertySuggestions.length > 0) {
            suggestionHTML += propertySuggestions
                .map(suggestion => `<div class="px-4 py-2 hover:bg-gray-100 cursor-pointer text-sm" onclick="selectSuggestion('${suggestion.replace(/'/g, "\\'")}')">
                    <i class="fas fa-search mr-2 text-gray-400"></i>${suggestion}
                </div>`)
                .join('');
        }
        
        if (complexSuggestions.length > 0) {
            if (propertySuggestions.length > 0) {
                suggestionHTML += '<div class="border-t border-gray-200 my-1"></div>';
            }
            suggestionHTML += complexSuggestions
                .map(complex => `<div class="px-4 py-2 hover:bg-gray-100 cursor-pointer text-sm" onclick="selectComplexSuggestion('${complex.name.replace(/'/g, "\\'")}')">
                    <i class="fas fa-building mr-2 text-[#0088CC]"></i><strong>${complex.name}</strong><br>
                    <small class="text-gray-500 ml-6">${complex.developer} • ${complex.apartments_count} квартир</small>
                </div>`)
                .join('');
        }
        
        if (suggestionHTML && suggestionsContainer) {
            suggestionsContainer.innerHTML = suggestionHTML;
            suggestionsContainer.classList.remove('hidden');
        } else if (suggestionsContainer) {
            suggestionsContainer.classList.add('hidden');
        }
    });
    
    // Hide suggestions when clicking outside
    document.addEventListener('click', function(e) {
        if (!searchInput.contains(e.target) && !suggestionsContainer.contains(e.target)) {
            if (suggestionsContainer) {
                suggestionsContainer.classList.add('hidden');
            }
        }
    });
}

// New smart search function
function performSmartSearch() {
    const searchValue = document.getElementById('property-search').value.trim();
    if (!searchValue) {
        alert('Введите поисковый запрос');
        return;
    }
    
    // Clear all current filters first
    clearAllFilters();
    
    // Try to detect and apply filters based on search
    const searchLower = searchValue.toLowerCase();
    
    // Check districts
    const districts = ['центральный', 'западный', 'карасунский', 'прикубанский', 'фестивальный'];
    districts.forEach(district => {
        if (searchLower.includes(district)) {
            const checkbox = document.querySelector(`input[data-filter-type="district"][value*="${district}"]`);
            if (checkbox) checkbox.checked = true;
        }
    });
    
    // Check property class
    const propertyClasses = ['эконом', 'комфорт', 'бизнес', 'премиум'];
    propertyClasses.forEach(cls => {
        if (searchLower.includes(cls)) {
            const checkbox = document.querySelector(`input[data-filter="property_class"][value*="${cls}"]`);
            if (checkbox) checkbox.checked = true;
        }
    });
    
    // Check wall materials
    const materials = ['кирпич', 'монолит', 'панель', 'газобетон'];
    materials.forEach(material => {
        if (searchLower.includes(material)) {
            const checkbox = document.querySelector(`input[data-filter="wall_material"][value*="${material}"]`);
            if (checkbox) checkbox.checked = true;
        }
    });
    
    // Apply filters and search
    applyFilters();
}

function selectSuggestion(suggestion, category) {
    document.getElementById('property-search').value = suggestion;
    document.getElementById('property-searchSuggestions').classList.add('hidden');
    
    // Auto-apply the selected filter
    if (category === 'district') {
        const checkbox = document.querySelector(`input[data-filter-type="district"][value="${suggestion}"]`);
        if (checkbox) {
            checkbox.checked = true;
            applyFilters();
        }
    } else if (category === 'developer') {
        const checkbox = document.querySelector(`input[data-filter-type="developer"][value="${suggestion}"]`) ||
                        document.querySelector(`input[data-filter="developer"][value="${suggestion}"]`);
        if (checkbox) {
            checkbox.checked = true;
            applyFilters();
        }
    } else if (category === 'propertyClass') {
        const checkbox = document.querySelector(`input[data-filter="property_class"][value="${suggestion}"]`);
        if (checkbox) {
            checkbox.checked = true;
            updateAdvancedFilters();
        }
    } else if (category === 'wallMaterial') {
        const checkbox = document.querySelector(`input[data-filter="wall_material"][value="${suggestion}"]`);
        if (checkbox) {
            checkbox.checked = true;
            updateAdvancedFilters();
        }
    } else if (category === 'floorsTotal') {
        const checkbox = document.querySelector(`input[data-filter="floors_total"][value="${suggestion}"]`);
        if (checkbox) {
            checkbox.checked = true;
            updateAdvancedFilters();
        }
    }
    
    console.log('Selected suggestion:', suggestion, 'Category:', category);
    
    // Apply search filter
    applyFilters();
}

function selectComplexSuggestion(complexName) {
    document.getElementById('property-search').value = complexName;
    document.getElementById('property-searchSuggestions').classList.add('hidden');
    applyFilters();
}

// Room filter functionality
document.addEventListener('DOMContentLoaded', function() {
    const roomButtons = document.querySelectorAll('.room-btn');
    
    roomButtons.forEach(button => {
        button.addEventListener('click', function() {
            const rooms = this.dataset.rooms;
            
            if (selectedRooms.has(rooms)) {
                selectedRooms.delete(rooms);
                this.classList.remove('bg-[#0088CC]', 'text-white', 'border-[#0088CC]');
                this.classList.add('border-gray-300', 'text-gray-700');
            } else {
                selectedRooms.add(rooms);
                this.classList.add('bg-[#0088CC]', 'text-white', 'border-[#0088CC]');
                this.classList.remove('border-gray-300', 'text-gray-700');
            }
            
            applyFilters();
        });
    });
});

// Apply all filters
function resetAllFilters() {
    // Reset all form elements
    document.getElementById('property-search').value = '';
    document.getElementById('district-filter').value = '';
    document.getElementById('developer-filter').value = '';
    document.getElementById('price-from').value = '';
    document.getElementById('price-to').value = '';
    document.getElementById('area-from').value = '';
    document.getElementById('area-to').value = '';
    document.getElementById('property-type-filter').value = '';
    document.getElementById('completion-date-filter').value = '';
    document.getElementById('mortgage-filter').value = '';
    document.getElementById('sort-select').value = 'price-asc';
    
    // Reset room buttons
    selectedRooms.clear();
    document.querySelectorAll('.room-btn').forEach(button => {
        button.classList.remove('bg-[#0088CC]', 'text-white', 'border-[#0088CC]');
        button.classList.add('border-gray-300', 'text-gray-700');
    });
    
    // Reset advanced filters
    if (typeof resetAdvancedFilters === 'function') {
        resetAdvancedFilters();
    }
    
    // Hide reset button
    document.getElementById('resetFiltersBtn').style.display = 'none';
    
    // Clear URL parameters and redirect to clean properties page
    window.location.href = '/properties';
}


// Update properties list display with pagination
function updatePropertiesList(properties) {
    const listContainer = document.getElementById('properties-container');
    
    if (!listContainer) {
        console.warn('Properties container not found - display mode may not be available');
        return;
    }
    
    if (properties.length === 0) {
        listContainer.innerHTML = `
            <div class="text-center py-12">
                <div class="text-gray-400 text-6xl mb-4">🔍</div>
                <h3 class="text-xl font-semibold text-gray-600 mb-2">Квартиры не найдены</h3>
                <p class="text-gray-500">Попробуйте изменить параметры поиска</p>
            </div>
        `;
        // Скрываем пагинацию если нет объектов
        const paginationContainer = document.getElementById('pagination-container');
        if (paginationContainer) paginationContainer.innerHTML = '';
        return;
    }
    
    // ✅ ИСПРАВЛЕНО: НЕ ДЕЛАЕМ пагинацию здесь - properties уже отфильтрованы для текущей страницы
    console.log(`📊 Рендерим ${properties.length} объектов для страницы ${currentPage}`);
    const paginatedProperties = properties; // Просто используем переданные свойства без дополнительной пагинации
    
    // Get current view mode from data attribute
    const isGridView = listContainer.getAttribute('data-view-mode') === 'grid';
    
    if (isGridView) {
        listContainer.className = 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6';
    } else {
        listContainer.className = 'space-y-6';
    }
    
    console.log(`🔄 Рендеринг: режим ${isGridView ? 'сетка' : 'список'}, страница ${currentPage}, объектов: ${properties.length}`);
    
    // Create manager block (will be inserted between properties) - uses user's manager or company data
    const manager = window.userManager;
    const managerName = manager ? manager.name : 'InBack';
    const managerPhone = manager ? manager.phone : '8 (862) 266-62-16';
    const managerEmail = manager ? manager.email : 'info@inback.ru';
    const managerPhoto = manager && manager.photo ? manager.photo : null;
    const managerInitials = manager ? (manager.name.split(' ')[0][0] + (manager.name.split(' ')[1] ? manager.name.split(' ')[1][0] : '')) : 'IB';
    const managerLabel = manager ? 'Менеджер' : 'InBack';
    const helpText = manager ? 'от вашего менеджера' : 'от нашей команды';
    
    const managerBlock = `
        <div class="manager-block bg-gray-100 rounded-lg p-4 border border-gray-200 shadow-sm relative ${isGridView ? 'md:col-span-2 lg:col-span-3' : ''}" id="manager-block-${currentPage}">
            <button class="absolute top-3 right-3 text-gray-400 hover:text-gray-600 transition-colors" onclick="this.parentElement.style.display='none';" title="×">
                <i class="fas fa-times"></i>
            </button>
            <div class="flex items-center gap-4">
                <div class="flex-shrink-0">
                    ${managerPhoto 
                        ? `<img src="${managerPhoto}" alt="${managerName}" class="w-16 h-16 rounded object-cover">` 
                        : manager 
                            ? `<div class="w-16 h-16 rounded bg-blue-600 flex items-center justify-center text-white text-sm font-bold">${managerInitials}</div>`
                            : `<div class="w-16 h-16 rounded bg-blue-600 flex items-center justify-center text-white text-xl"><i class="fas fa-building"></i></div>`
                    }
                    <div class="bg-blue-600 text-white text-xs px-2 py-1 rounded mt-1 text-center font-medium">${managerLabel}</div>
                </div>
                <div class="flex-1">
                    <h3 class="text-lg font-semibold text-gray-900 mb-1">${managerName}</h3>
                    <p class="text-gray-600 text-sm mb-3">Получите бесплатную помощь ${helpText} по покупке новостройки</p>
                    <div class="flex items-center gap-4 text-sm">
                        <div class="flex items-center gap-1 text-blue-600">
                            <i class="fas fa-phone text-xs"></i>
                            <span>${managerPhone}</span>
                        </div>
                        <div class="flex items-center gap-1 text-blue-600">
                            <i class="fas fa-envelope text-xs"></i>
                            <span>${managerEmail}</span>
                        </div>
                    </div>
                </div>
                <div class="flex-shrink-0">
                    <button onclick="openApplicationModal()" class="bg-blue-600 text-white px-4 py-2 rounded text-sm font-medium hover:bg-blue-700 transition">
                        <i class="fas fa-comments mr-1"></i>
                        Связаться
                    </button>
                </div>
            </div>
        </div>
    `;
    
    // Render paginated properties with manager blocks inserted
    const propertyCards = [];
    paginatedProperties.forEach((property, index) => {
        // Add manager block after every 6th property (every 2 rows in grid view)
        if (index > 0 && index % 6 === 0) {
            propertyCards.push(managerBlock);
        }
        
        // Создаем карточку в зависимости от вида отображения
        if (isGridView) {
            // Вертикальная карточка для сетки
            propertyCards.push(`
            <div class="property-card bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden cursor-pointer flex flex-col h-full" 
                 data-type="${property.type}" 
                 data-rooms="${property.rooms}" 
                 data-price="${property.price}" 
                 data-district="${property.district}" 
                 data-developer="${property.developer}"
                 data-complex="${property.complex_name || 'Не указан'}"
                 data-property-type="${property.property_type || property.type}"

                
                <!-- Image Section -->
                <div class="relative h-48 group">
                    <div class="carousel-container w-full h-full relative overflow-hidden bg-gray-100" data-property-id="${property.id}">
                        ${(property.gallery && property.gallery.length > 0 ? property.gallery : [property.image]).map((image, index) => `
                            <div class="carousel-slide absolute inset-0 transition-opacity duration-300 ${index === 0 ? '' : 'opacity-0'}" data-slide="${index}">
                                <img src="${image}" alt="${property.rooms == 0 ? 'Студия' : property.rooms + '-комн'} ${property.area} м²" class="w-full h-full object-cover">
                            </div>
                        `).join('')}
                        
                        ${(property.gallery && property.gallery.length > 1) ? `
                        <button onclick="event.stopPropagation(); event.preventDefault(); prevImageSlide(this, event);" class="absolute left-2 top-1/2 -translate-y-1/2 w-6 h-6 bg-black/50 hover:bg-black/70 text-white rounded-full flex items-center justify-center transition-all opacity-0 group-hover:opacity-100 z-10">
                            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                            </svg>
                        </button>
                        <button onclick="event.stopPropagation(); event.preventDefault(); nextImageSlide(this, event);" class="absolute right-2 top-1/2 -translate-y-1/2 w-6 h-6 bg-black/50 hover:bg-black/70 text-white rounded-full flex items-center justify-center transition-all opacity-0 group-hover:opacity-100 z-10">
                            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                            </svg>
                        </button>
                        ` : ''}
                    </div>
                    
                    <!-- Badges -->
                    <div class="absolute top-2 left-2 bg-blue-600 text-white text-xs font-medium px-2 py-1 rounded z-20">
                        Кэшбек до ${Math.round(property.cashback || 0).toLocaleString('ru-RU')} ₽
                    </div>
                    
                    <div class="absolute top-2 right-2 w-7 h-7 bg-white/90 hover:bg-white rounded-full flex items-center justify-center shadow cursor-pointer favorite-heart z-20" data-property-id="${property.id}" title="Добавить в избранное">
                        <i class="fas fa-heart text-gray-400 hover:text-red-500 text-xs transition-colors"></i>
                    </div>
                </div>
                
                <!-- Content -->
                <div class="p-4 flex flex-col flex-1">
                    <h3 class="font-semibold text-gray-900 mb-2 text-sm">
                        ${property.rooms == 0 ? 'Студия' : property.rooms + '-комн'}, ${property.area} м², ${property.floor}/${property.total_floors} эт.
                    </h3>
                    
                    <div class="mb-2">
                        <a href="${(property.residential_complex || property.complex_name) ? '/residential-complex/' + (property.residential_complex || property.complex_name) : '#'}" 
                           class="text-blue-600 hover:text-blue-700 hover:underline text-xs" onclick="event.stopPropagation();">
                            ${property.residential_complex || property.complex_name || 'ЖК Летний'}
                        </a>
                        <span class="text-blue-600 text-xs"> • Краснодар</span>
                    </div>
                    
                    <div class="text-gray-600 text-xs mb-3">
                        <span class="font-medium">Застройщик:</span> ${property.developer || property.developer_name || 'ГК Неометрия'}
                    </div>
                    
                    <div class="flex-1"></div>
                    
                    <div class="flex items-center justify-between mt-auto">
                        <div>
                            ${property.price && property.price > 0 ? `
                            <div class="text-lg font-bold text-gray-900">
                                ${property.price.toLocaleString('ru-RU')} ₽
                            </div>
                            <div class="text-xs text-green-600">
                                от ${Math.floor(property.price * 0.05 / 12).toLocaleString('ru-RU')} ₽/мес
                            </div>
                            ` : `
                            <div class="text-lg font-bold text-gray-900">
                                По запросу
                            </div>
                            `}
                        </div>
                        <div class="flex gap-1">
                            <a href="/object/${property.id}/pdf" target="_blank" 
                               class="w-8 h-8 bg-white border border-gray-300 rounded flex items-center justify-center text-gray-600 hover:bg-blue-50 hover:border-blue-300 hover:text-blue-600 transition-all" 
                               title="PDF" onclick="event.stopPropagation();">
                                <i class="fas fa-file-pdf text-xs"></i>
                            </a>
                            <button class="compare-btn w-8 h-8 bg-white border border-gray-300 rounded flex items-center justify-center text-gray-600 hover:bg-blue-50 hover:border-blue-300 hover:text-blue-600 transition-all" 
                                    data-property-id="${property.id}" title="Сравнить">
                                <i class="fas fa-balance-scale text-xs"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>`);
        } else {
            // Горизонтальная карточка для списка
            propertyCards.push(`
            <div class="property-card bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden w-full flex cursor-pointer min-h-[280px]" 
                 data-type="${property.type}" 
                 data-rooms="${property.rooms}" 
                 data-price="${property.price}" 
                 data-district="${property.district}" 
                 data-developer="${property.developer}"
                 data-complex="${property.complex_name || 'Не указан'}"
                 data-property-type="${property.property_type || property.type}"

                
                <!-- Image Section with Slider -->
                <div class="relative w-80 h-60 flex-shrink-0 group">
                    <div class="carousel-container w-full h-60 relative overflow-hidden bg-gray-100 rounded-lg" data-property-id="${property.id}">
                        ${(property.gallery && property.gallery.length > 0 ? property.gallery : [property.image]).map((image, index) => `
                            <div class="carousel-slide absolute inset-0 transition-opacity duration-300 ${index === 0 ? '' : 'opacity-0'}" data-slide="${index}">
                                <img src="${image}" alt="${property.rooms == 0 ? 'Студия' : property.rooms + '-комн'} ${property.area} м² - фото ${index + 1}" class="w-full h-full object-cover">
                            </div>
                        `).join('')}
                        
                        ${(property.gallery && property.gallery.length > 1) ? `
                        <!-- Navigation arrows -->
                        <button onclick="event.stopPropagation(); event.preventDefault(); prevImageSlide(this, event);" class="absolute left-2 top-1/2 -translate-y-1/2 w-8 h-8 bg-black/50 hover:bg-black/70 text-white rounded-full flex items-center justify-center transition-all opacity-0 group-hover:opacity-100 z-10">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                            </svg>
                        </button>
                        <button onclick="event.stopPropagation(); event.preventDefault(); nextImageSlide(this, event);" class="absolute right-2 top-1/2 -translate-y-1/2 w-8 h-8 bg-black/50 hover:bg-black/70 text-white rounded-full flex items-center justify-center transition-all opacity-0 group-hover:opacity-100 z-10">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                            </svg>
                        </button>
                        
                        <!-- Dots indicator -->
                        <div class="absolute bottom-3 left-1/2 -translate-x-1/2 flex gap-1.5 opacity-0 group-hover:opacity-100 transition-opacity z-10">
                            ${(property.gallery && property.gallery.length > 0 ? property.gallery : [property.image]).slice(0, 4).map((_, index) => `
                                <button onclick="event.stopPropagation(); event.preventDefault(); goToImageSlide(this, ${index}, event);" class="w-2.5 h-2.5 rounded-full ${index === 0 ? 'bg-white/80' : 'bg-white/50'} hover:bg-white transition-colors"></button>
                            `).join('')}
                        </div>
                        ` : ''}
                    </div>
                    
                    <!-- Blue Cashback Badge -->
                    <div class="absolute top-3 left-3 bg-blue-600 text-white text-xs font-medium px-2 py-1 rounded z-20">
                        Кэшбек до ${Math.round(property.cashback || 0).toLocaleString('ru-RU')} ₽
                    </div>
                    
                    <!-- Favorite Icons Container -->
                    <div class="absolute top-3 right-3 flex gap-2 z-20">
                        <!-- Universal Heart Icon -->
                        <div class="w-8 h-8 bg-white/90 hover:bg-white rounded-full flex items-center justify-center shadow cursor-pointer favorite-heart z-20" data-property-id="${property.id}" title="Добавить в избранное">
                            <i class="fas fa-heart text-gray-400 hover:text-red-500 text-sm transition-colors"></i>
                        </div>
                    </div>
                </div>
                
                <!-- Content Section -->
                <div class="flex-1 p-6 flex flex-col">
                    <!-- Title -->
                    <h2 class="text-xl font-semibold text-gray-900 mb-3">
                        ${property.rooms == 0 ? 'Студия' : property.rooms + '-комн'}, ${property.area} м², ${property.floor}/${property.total_floors} эт.
                    </h2>
                    
                    <!-- Complex and Location -->
                    <div class="mb-2">
                        <a href="${(property.residential_complex || property.complex_name) ? '/residential-complex/' + (property.residential_complex || property.complex_name) : '#'}" 
                           class="text-blue-600 hover:text-blue-700 hover:underline text-sm font-medium" onclick="event.stopPropagation();">
                            ${property.residential_complex || property.complex_name || 'ЖК Летний'}
                        </a>
                        <span class="text-blue-600 text-sm"> • Краснодарский край</span>
                    </div>
                    
                    <!-- Address -->
                    <div class="text-gray-500 text-sm mb-2">
                        ${property.address || 'Россия, Краснодарский край, Сочи, Кудепста м-н, Искра, 88 лит7'}
                    </div>
                    
                    <!-- Developer -->
                    <div class="text-gray-700 text-sm mb-4">
                        <span class="font-medium">Застройщик:</span> ${property.developer || property.developer_name || 'ГК Неометрия'}
                    </div>
                    
                    <!-- Tags -->
                    <div class="flex gap-2 mb-4">
                        <span class="bg-gray-100 text-gray-700 px-2 py-1 rounded text-xs">${property.floor}-й этаж</span>
                        <span class="bg-gray-100 text-gray-700 px-2 py-1 rounded text-xs">${property.renovation_display_name || 'Без отделки'}</span>
                        <span class="bg-gray-100 text-gray-700 px-2 py-1 rounded text-xs">${property.complex_object_class_display_name || 'Комфорт'}</span>
                    </div>
                    
                    <div class="flex-1"></div>
                    
                    <!-- Action Buttons Row with Price and Mortgage Info -->
                    <div class="flex items-center justify-between">
                        <div class="flex flex-col gap-2">
                            ${property.price && property.price > 0 ? `
                            <div class="text-2xl font-bold text-gray-900">
                                ${property.price.toLocaleString('ru-RU')} ₽
                            </div>
                            <div class="bg-green-100 text-green-800 text-xs px-2 py-1 rounded">
                                от ${Math.floor(property.price * 0.05 / 12).toLocaleString('ru-RU')} ₽/мес ипотека
                            </div>
                            ` : `
                            <div class="text-2xl font-bold text-gray-900">
                                Цена по запросу
                            </div>
                            `}
                        </div>
                        <div class="flex gap-2">
                            <a href="/object/${property.id}/pdf" target="_blank" 
                               class="w-10 h-10 bg-white border border-gray-300 rounded flex items-center justify-center text-gray-600 hover:bg-blue-50 hover:border-blue-300 hover:text-blue-600 hover:scale-105 transition-all duration-200" 
                               title="Скачать PDF" onclick="event.stopPropagation();">
                                <i class="fas fa-file-pdf"></i>
                            </a>
                            <button class="compare-btn w-10 h-10 bg-white border border-gray-300 rounded flex items-center justify-center text-gray-600 hover:bg-blue-50 hover:border-blue-300 hover:text-blue-600 hover:scale-105 transition-all duration-200" 
                                    data-property-id="${property.id}" title="Добавить к сравнению">
                                <i class="fas fa-balance-scale"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>`);
        }
    });
    
    // Set the combined content to container
    listContainer.innerHTML = propertyCards.join('');
    
    // ✅ УБРАЛИ: НЕ обновляем пагинацию здесь - это делается в filterProperties()
    // updatePaginationControls(totalItems, totalPages);
    
    // Initialize favorites and comparison buttons after rendering
    setTimeout(() => {
        initializeAllButtons();
        
        // КРИТИЧНО: После рендеринга переинициализируем избранные для ВСЕХ пользователей
        if (window.favoritesManager) {
            console.log('🔄 Updating favorites UI after rendering');
            window.favoritesManager.updateFavoritesUI();
            window.favoritesManager.updateComplexFavoritesUI();
        }
        
        // КРИТИЧНО: Инициализация кнопок презентации для менеджеров
        const isManager = document.querySelector('a[href*="manager/dashboard"]') !== null;
        console.log('🔍 Checking manager status:', isManager);
        console.log('🔍 Property cards found:', document.querySelectorAll('.property-card').length);
        
        if (isManager) {
            let addedButtons = 0;
            // Добавляем кнопки презентации в правильный контейнер рядом с кнопкой сравнения
            document.querySelectorAll('.property-card').forEach((card, index) => {
                const existingPresentationBtn = card.querySelector('.presentation-btn');
                const compareBtn = card.querySelector('.compare-btn');
                const propertyId = compareBtn?.getAttribute('data-property-id') || 
                                 card.querySelector('.favorite-heart')?.getAttribute('data-property-id');
                
                console.log(`🔍 Card ${index}: compareBtn=${!!compareBtn}, existingBtn=${!!existingPresentationBtn}, propertyId=${propertyId}`);
                
                // Ищем контейнер кнопки сравнения - именно туда нужно добавить кнопку презентации
                if (compareBtn && !existingPresentationBtn && propertyId) {
                    const buttonsContainer = compareBtn.parentElement;
                    console.log(`🔍 Found buttons container:`, buttonsContainer?.className);
                    
                    if (buttonsContainer) {
                        const presentationBtn = document.createElement('button');
                        presentationBtn.className = 'presentation-btn w-10 h-10 bg-white border border-purple-300 rounded flex items-center justify-center text-purple-600 hover:bg-purple-50 hover:border-purple-400 hover:text-purple-700 hover:scale-105 transition-all duration-200';
                        presentationBtn.setAttribute('data-property-id', propertyId);
                        presentationBtn.title = 'Добавить в презентацию';
                        presentationBtn.innerHTML = '<i class="fas fa-plus"></i>';
                        presentationBtn.onclick = function(e) {
                            e.stopPropagation();
                            openPresentationModal(propertyId);
                        };
                        buttonsContainer.appendChild(presentationBtn);
                        addedButtons++;
                    }
                }
            });
            console.log(`🔄 Кнопки презентации добавлены: ${addedButtons} из ${document.querySelectorAll('.property-card').length}`);
        }
        
        // КРИТИЧНО: Исправляем кнопки сравнения после обновления списка
        if (typeof ensureCompareButtonIcons === 'function') {
            ensureCompareButtonIcons();
        }
        
        // КРИТИЧНО: Переинициализируем обработчики событий для новых кнопок
        setTimeout(() => {
            // Переинициализируем избранные для ВСЕХ пользователей
            if (window.favoritesManager) {
                window.favoritesManager.updateFavoritesUI();
                window.favoritesManager.updateComplexFavoritesUI();
            }
            
            // Используем новую функцию реинициализации кнопок сравнения
            if (typeof window.reinitComparisonButtons === 'function') {
                window.reinitComparisonButtons();
            }
        }, 100);
        
        console.log('Property list updated, buttons initialized');
    }, 50);
}

// Advanced Filters System  
let activeFilters = {};
let originalProperties = [...allProperties];

function initializeClearAllButton() {
    // Clear all filters button - добавляем обработчик для правильной функции
    console.log('🔧 Инициализация кнопки "Очистить все"...');
    const clearAllBtn = document.getElementById('clearAllFilters');
    if (clearAllBtn) {
        console.log('✅ Кнопка clearAllFilters найдена, добавляем обработчик');
        clearAllBtn.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            console.log('🎯 Кнопка "Очистить все" нажата - вызываем правильную функцию');
            try {
                clearAllActiveFilters();
            } catch (error) {
                console.error('❌ Ошибка при очистке фильтров:', error);
            }
        });
        console.log('✅ Обработчик кнопки clearAllFilters установлен');
    } else {
        console.warn('⚠️ Кнопка clearAllFilters не найдена в DOM');
        console.log('🔍 Поиск всех кнопок на странице:');
        const allButtons = document.querySelectorAll('button');
        allButtons.forEach((btn, index) => {
            console.log(`Кнопка ${index}: id="${btn.id}", class="${btn.className}", text="${btn.textContent.trim()}"`);
        });
    }
}

// ✅ УДАЛЕНА: Первая дублирующая функция

// Initialize dropdown filters functionality
function initializeDropdownFilters() {
    console.log('🔧 initializeDropdownFilters() CALLED');
    
    // Remove existing listeners to prevent duplicates
    const existingListeners = document.querySelectorAll('[data-dropdown-initialized]');
    existingListeners.forEach(el => el.removeAttribute('data-dropdown-initialized'));
    
    // Get property filter buttons - include quick filters but exclude header dropdowns  
    const searchSection = document.querySelector('section.py-8.bg-gray-50');
    const propertySection = document.querySelector('section.container.mx-auto.px-4.py-6');
    
    console.log('🔍 searchSection:', searchSection);
    console.log('🔍 propertySection:', propertySection);
    
    if (!searchSection && !propertySection) {
        console.error('❌ NO sections found!');
        return;
    }
    
    // Get quick filter buttons from search section and advanced filter buttons from property section
    let filterButtons = [];
    if (searchSection) {
        const quickFilterBtns = Array.from(searchSection.querySelectorAll('.dropdown .dropdown-btn'));
        console.log(`✅ Found ${quickFilterBtns.length} quick filter buttons in searchSection`);
        filterButtons = filterButtons.concat(quickFilterBtns);
    }
    if (propertySection) {
        filterButtons = filterButtons.concat(Array.from(propertySection.querySelectorAll('.filter-dropdown .filter-option-btn, #toggleAllFilters')));
    }
    
    // Also get buttons from advanced filters section
    const advancedSection = document.querySelector('#advancedFiltersSection');
    if (advancedSection) {
        filterButtons = filterButtons.concat(Array.from(advancedSection.querySelectorAll('.filter-dropdown .filter-option-btn')));
    }
    
    filterButtons.forEach(button => {
        // Skip if already initialized
        if (button.hasAttribute('data-dropdown-initialized')) return;
        button.setAttribute('data-dropdown-initialized', 'true');
        
        button.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            if (this.id === 'toggleAllFilters') {
                // Handle "Все фильтры" button specially
                toggleAdvancedFilters();
                return;
            }
            
            const dropdown = this.closest('.filter-dropdown') || this.closest('.dropdown');
            let menu = null;
            
            if (dropdown) {
                menu = dropdown.querySelector('.dropdown-menu');
            }
            
            if (!menu && dropdown) {
                // Also check for filter-dropdown-menu class for advanced filters
                menu = dropdown.querySelector('.filter-dropdown-menu');
            }
            
            if (menu) {
                // Check current menu state BEFORE closing others
                let isCurrentMenuOpen = false;
                if (menu.classList.contains('dropdown-menu')) {
                    isCurrentMenuOpen = menu.classList.contains('open');
                } else if (menu.classList.contains('filter-dropdown-menu')) {
                    isCurrentMenuOpen = !menu.classList.contains('hidden');
                }
                
                // Close all dropdowns including the current one
                document.querySelectorAll('.dropdown-menu.open, .filter-dropdown-menu:not(.hidden)').forEach(openMenu => {
                    openMenu.classList.remove('open');
                    openMenu.classList.add('hidden');
                });
                
                // If the clicked menu was closed, open it
                if (!isCurrentMenuOpen) {
                    if (menu.classList.contains('dropdown-menu')) {
                        menu.classList.add('open');
                        menu.classList.remove('hidden');
                    } else if (menu.classList.contains('filter-dropdown-menu')) {
                        menu.classList.remove('hidden');
                    }
                    console.log('Dropdown opened');
                } else {
                    console.log('Dropdown closed');
                }
            }
        });
    });
    
    // Remove existing document click listener and add fresh one
    if (window.dropdownDocumentListener) {
        document.removeEventListener('click', window.dropdownDocumentListener);
    }
    
    window.dropdownDocumentListener = function(e) {
        // Only close property filter dropdowns, never touch header
        const searchSection = document.querySelector('section.py-8.bg-gray-50');
        const propertySection = document.querySelector('section.container.mx-auto.px-4.py-6');
        
        if (!e.target.closest('.filter-dropdown') && !e.target.closest('.dropdown') && !e.target.closest('#allFiltersPanel') && !e.target.closest('header') && !e.target.closest('nav')) {
            // Close dropdowns within search section (quick filters)
            if (searchSection) {
                searchSection.querySelectorAll('.dropdown-menu.open').forEach(menu => {
                    menu.classList.remove('open');
                });
            }
            
            // Close dropdowns within property section (advanced filters)
            if (propertySection) {
                propertySection.querySelectorAll('.dropdown-menu.open').forEach(menu => {
                    menu.classList.remove('open');
                });
                propertySection.querySelectorAll('.filter-dropdown-menu:not(.hidden)').forEach(menu => {
                    menu.classList.add('hidden');
                });
                propertySection.querySelectorAll('#allFiltersPanel').forEach(panel => {
                    panel.classList.add('hidden');
                });
            }
            
            // Close dropdowns within advanced filters section
            const advancedSection = document.querySelector('#advancedFiltersSection');
            if (advancedSection) {
                advancedSection.querySelectorAll('.dropdown-menu.open').forEach(menu => {
                    menu.classList.remove('open');
                });
                advancedSection.querySelectorAll('.filter-dropdown-menu:not(.hidden)').forEach(menu => {
                    menu.classList.add('hidden');
                });
            }
        }
    };
    
    document.addEventListener('click', window.dropdownDocumentListener);
}

// Handle room filter changes
function handleRoomFilterChange() {
    // Add small delay to prevent rapid fire events
    if (window.roomFilterTimeout) {
        clearTimeout(window.roomFilterTimeout);
    }
    
    window.roomFilterTimeout = setTimeout(() => {
        const checkedRooms = Array.from(document.querySelectorAll('input[data-filter-type="rooms"]:checked')).map(cb => cb.value);
        console.log('Room filters changed:', checkedRooms);
        
        // Map numeric values to display labels
        const roomLabels = {
            '0': 'Студия',
            '1': '1-комн',
            '2': '2-комн',
            '3': '3-комн',
            '4': '4-комн'
        };
        
        // Update button text
        const buttonText = document.getElementById('roomsFilterText');
        if (buttonText) {
            if (checkedRooms.length === 0) {
                buttonText.textContent = 'Комнат';
            } else if (checkedRooms.length === 1) {
                buttonText.textContent = roomLabels[checkedRooms[0]] || checkedRooms[0];
            } else {
                buttonText.textContent = `${checkedRooms.length} типов`;
            }
        }
        
        // ✅ REMOVED: filterProperties() - only update UI, actual filtering happens via "Найти" button
    }, 100);
}

// Handle region filter changes
function handleRegionFilterChange() {
    if (window.regionFilterTimeout) {
        clearTimeout(window.regionFilterTimeout);
    }
    
    window.regionFilterTimeout = setTimeout(() => {
        const checkedRegions = Array.from(document.querySelectorAll('input[data-filter-type="region"]:checked')).map(cb => cb.value);
        console.log('Region filters changed:', checkedRegions);
        
        // Update button text
        const buttonText = document.getElementById('regionFilterText');
        if (buttonText) {
            if (checkedRegions.length === 0) {
                buttonText.textContent = 'Регион';
            } else if (checkedRegions.length === 1) {
                buttonText.textContent = checkedRegions[0];
            } else {
                buttonText.textContent = `${checkedRegions.length} регионов`;
            }
        }
        
        // ✅ REMOVED: filterProperties() - only update UI, actual filtering happens via "Найти" button
    }, 100);
}

// Handle city filter changes
function handleCityFilterChange() {
    if (window.cityFilterTimeout) {
        clearTimeout(window.cityFilterTimeout);
    }
    
    window.cityFilterTimeout = setTimeout(() => {
        const checkedCities = Array.from(document.querySelectorAll('input[data-filter-type="city"]:checked')).map(cb => cb.value);
        console.log('City filters changed:', checkedCities);
        
        // Update button text
        const buttonText = document.getElementById('cityFilterText');
        if (buttonText) {
            if (checkedCities.length === 0) {
                buttonText.textContent = 'Город';
            } else if (checkedCities.length === 1) {
                buttonText.textContent = checkedCities[0];
            } else {
                buttonText.textContent = `${checkedCities.length} городов`;
            }
        }
        
        // ✅ REMOVED: filterProperties() - only update UI, actual filtering happens via "Найти" button
    }, 100);
}

// Apply filters with proper function name
function applyFiltersFixed() {
    console.log('Applying filters...');
    filterProperties();
}

// Apply price filter
function applyPriceFilter() {
    const priceFrom = document.getElementById('priceFrom').value;
    const priceTo = document.getElementById('priceTo').value;
    
    console.log('Price filter:', priceFrom, 'to', priceTo);
    
    // Update button text
    const buttonText = document.getElementById('priceFilterText');
    if (priceFrom || priceTo) {
        let text = 'Цена ';
        if (priceFrom) text += `от ${priceFrom}млн `;
        if (priceTo) text += `до ${priceTo}млн`;
        buttonText.textContent = text.trim() + ' ₽';
    } else {
        buttonText.textContent = 'Цена от-до, ₽';
    }
    
    // Only update filter state and display active filters, don't trigger search
    displayActiveFilters();
    
    // Close dropdown
    const dropdown = document.querySelector('[data-filter="price"] .dropdown-menu');
    if (dropdown) dropdown.classList.remove('open');
}

// Apply advanced filters from "Еще" section
function applyAdvancedFilters() {
    console.log('Applying advanced filters...');
    
    // Collect all advanced filter values
    const advancedFilters = {};
    
    // Area range
    const areaFrom = document.getElementById('areaFrom').value;
    const areaTo = document.getElementById('areaTo').value;
    if (areaFrom) advancedFilters.areaFrom = parseInt(areaFrom);
    if (areaTo) advancedFilters.areaTo = parseInt(areaTo);
    
    // Floor range
    const floorFrom = document.getElementById('floorFrom').value;
    const floorTo = document.getElementById('floorTo').value;
    if (floorFrom) advancedFilters.floorFrom = parseInt(floorFrom);
    if (floorTo) advancedFilters.floorTo = parseInt(floorTo);
    
    // Building type (этажность дома)
    const buildingTypes = Array.from(document.querySelectorAll('input[data-filter-type="building_type"]:checked')).map(cb => cb.value);
    if (buildingTypes.length > 0) advancedFilters.buildingTypes = buildingTypes;
    
    // Building status (статус сдачи) - ИСПРАВЛЕНО  
    const buildingReleased = Array.from(document.querySelectorAll('input[data-filter-type="building_released"]:checked')).map(cb => cb.value);
    if (buildingReleased.length > 0) advancedFilters.buildingReleased = buildingReleased;
    
    // Build year range (диапазон года сдачи)
    const buildYearFrom = document.getElementById('buildYearFrom')?.value;
    const buildYearTo = document.getElementById('buildYearTo')?.value;
    if (buildYearFrom || buildYearTo) {
        advancedFilters.buildYearRange = {
            from: buildYearFrom ? parseInt(buildYearFrom) : null,
            to: buildYearTo ? parseInt(buildYearTo) : null
        };
    }
    
    // Features (особенности)
    const features = Array.from(document.querySelectorAll('input[data-filter-type="features"]:checked')).map(cb => cb.value);
    if (features.length > 0) advancedFilters.features = features;
    
    // Object class (класс жилья)
    const objectClasses = Array.from(document.querySelectorAll('input[data-filter-type="object_class"]:checked')).map(cb => cb.value);
    if (objectClasses.length > 0) advancedFilters.objectClasses = objectClasses;
    
    // Update activeFilters with advanced filters
    Object.assign(activeFilters, advancedFilters);
    
    console.log('Advanced filters applied:', advancedFilters);
    
    // Update filters counter
    const totalFilters = Object.keys(advancedFilters).length;
    const counter = document.getElementById('allFiltersCounter');
    if (counter) {
        if (totalFilters > 0) {
            counter.textContent = totalFilters;
            counter.classList.remove('hidden');
        } else {
            counter.classList.add('hidden');
        }
    }
    
    // Apply filters
    filterProperties();
    displayActiveFilters();
    
    // Close dropdown
    const dropdown = document.querySelector('[data-filter="advanced"] .dropdown-menu');
    if (dropdown) dropdown.classList.remove('open');
}

// Toggle advanced filters section
function toggleAdvancedFilters() {
    const section = document.getElementById('advancedFiltersSection');
    if (section) {
        section.classList.toggle('hidden');
        console.log('Advanced filters toggled:', !section.classList.contains('hidden'));
    }
}

// Enhanced filter properties function with room filtering
function filterProperties() {
    // Prevent concurrent filtering operations
    if (window.isFiltering) return;
    window.isFiltering = true;
    
    try {
        if (!allProperties || allProperties.length === 0) {
            console.log('No properties to filter');
            return;
        }
        
        // Get room filters
        const selectedRooms = Array.from(document.querySelectorAll('input[data-filter-type="rooms"]:checked')).map(cb => cb.value);
        
        // Get price filters  
        const priceFromEl = document.getElementById('priceFrom');
        const priceToEl = document.getElementById('priceTo');
        const priceFrom = priceFromEl ? parseFloat(priceFromEl.value || 0) : 0;
        const priceTo = priceToEl ? parseFloat(priceToEl.value || 0) : 0;
        
        // Get completion date filters
        const selectedCompletionDates = Array.from(document.querySelectorAll('input[data-filter-type="completion"]:checked')).map(cb => cb.value);
        
        // Get ADVANCED filters from "Еще" section
        const areaFromEl = document.getElementById('areaFrom');
        const areaToEl = document.getElementById('areaTo');
        const areaFrom = areaFromEl ? parseFloat(areaFromEl.value || 0) : 0;
        const areaTo = areaToEl ? parseFloat(areaToEl.value || 0) : 0;
        
        const floorFromEl = document.getElementById('floorFrom');
        const floorToEl = document.getElementById('floorTo');
        const floorFrom = floorFromEl ? parseInt(floorFromEl.value || 0) : 0;
        const floorTo = floorToEl ? parseInt(floorToEl.value || 0) : 0;
        
        // Building floors range (этажность дома) - используем числовые поля maxFloorFrom/maxFloorTo
        const maxFloorFromEl = document.getElementById('maxFloorFrom');
        const maxFloorToEl = document.getElementById('maxFloorTo');
        const maxFloorFrom = maxFloorFromEl ? parseInt(maxFloorFromEl.value || 0) : 0;
        const maxFloorTo = maxFloorToEl ? parseInt(maxFloorToEl.value || 0) : 0;
        
        // Building types - используем числовые поля вместо чекбоксов (чекбоксов нет в HTML)
        const selectedBuildingTypes = []; // Пустой массив - фильтр отключен
        const selectedBuildingReleased = Array.from(document.querySelectorAll('input[data-filter-type="building_released"]:checked')).map(cb => cb.value);
        const selectedFeatures = Array.from(document.querySelectorAll('input[data-filter-type="features"]:checked')).map(cb => cb.value);
        const selectedRenovationTypes = Array.from(document.querySelectorAll('input[data-filter-type="renovation"]:checked')).map(cb => cb.value);
        const selectedObjectClasses = Array.from(document.querySelectorAll('input[data-filter-type="object_class"]:checked')).map(cb => cb.value);
        const selectedDevelopers = Array.from(document.querySelectorAll('input[data-filter-type="developer"]:checked')).map(cb => cb.value);
        const selectedDistricts = Array.from(document.querySelectorAll('input[data-filter-type="district"]:checked')).map(cb => cb.value);
        
        // Get regional filters
        const selectedRegions = Array.from(document.querySelectorAll('input[data-filter-type="region"]:checked')).map(cb => cb.value);
        const selectedCities = Array.from(document.querySelectorAll('input[data-filter-type="city"]:checked')).map(cb => cb.value);
        
        console.log('Filtering with:', {
            rooms: selectedRooms,
            priceFrom: priceFrom,
            priceTo: priceTo,
            completion: selectedCompletionDates,
            area: {from: areaFrom, to: areaTo},
            floor: {from: floorFrom, to: floorTo},
            buildingTypes: selectedBuildingTypes,
            buildingFloors: {from: maxFloorFrom, to: maxFloorTo},
            buildingReleased: selectedBuildingReleased,
            features: selectedFeatures,
            renovation: selectedRenovationTypes,
            objectClasses: selectedObjectClasses,
            developers: selectedDevelopers,
            districts: selectedDistricts,
            regions: selectedRegions,
            cities: selectedCities,
            complex: activeFilters.residential_complex || null  // ✅ Добавлен фильтр по ЖК
        });
        
        // Debug: Show filter details
        if (floorFrom > 0 || floorTo > 0) {
            console.log(`Floor filter active: from ${floorFrom} to ${floorTo}`);
        }
        if (selectedDevelopers.length > 0) {
            console.log(`Developer filter active:`, selectedDevelopers);
        }
        
        // Debug: show some sample property data
        if (allProperties.length > 0) {
            console.log('Sample property for debugging:', {
                price: allProperties[0].price,
                priceInMillions: allProperties[0].price / 1000000,
                completion_date: allProperties[0].completion_date,
                rooms: allProperties[0].rooms,
                developer_name: allProperties[0].developer_name,
                complex_object_class_display_name: allProperties[0].complex_object_class_display_name,
                renovation_display_name: allProperties[0].renovation_display_name,
                object_min_floor: allProperties[0].object_min_floor,
                object_max_floor: allProperties[0].object_max_floor,
                object_area: allProperties[0].object_area
            });
        }
        
        filteredProperties = allProperties.filter(property => {
            // Room filter (merge quick and advanced filters)
            const allSelectedRooms = [...selectedRooms];
            if (advancedFilters.roomTypes && advancedFilters.roomTypes.length > 0) {
                allSelectedRooms.push(...advancedFilters.roomTypes);
            }
            
            if (allSelectedRooms.length > 0) {
                const match = allSelectedRooms.some(room => {
                    // ✅ Support numeric values from filter checkboxes
                    const roomNum = parseInt(room);
                    
                    // Check if it's a valid numeric value
                    if (!isNaN(roomNum)) {
                        if (roomNum === 4) {
                            return property.rooms >= 4;  // 4+ комнатная
                        }
                        return property.rooms === roomNum;
                    }
                    
                    // ✅ FALLBACK: Support old text formats for backward compatibility
                    const normalizedRoom = room.toLowerCase();
                    
                    if (normalizedRoom === 'студия' || normalizedRoom === 'studio') {
                        return property.rooms === 0;  // Студия = 0 комнат
                    }
                    if (normalizedRoom === '1-комн' || normalizedRoom === '1-комнатная' || normalizedRoom === '1 комнатная') {
                        return property.rooms === 1;  // 1-комнатная
                    }
                    if (normalizedRoom === '2-комн' || normalizedRoom === '2-комнатная' || normalizedRoom === '2 комнатная') {
                        return property.rooms === 2;  // 2-комнатная
                    }
                    if (normalizedRoom === '3-комн' || normalizedRoom === '3-комнатная' || normalizedRoom === '3 комнатная') {
                        return property.rooms === 3;  // 3-комнатная
                    }
                    if (normalizedRoom === '4+-комн' || normalizedRoom === '4-комнатная' || normalizedRoom === '4 комнатная' || normalizedRoom.includes('4+')) {
                        return property.rooms >= 4;   // 4+ комнатная
                    }
                    return false;
                });
                if (!match) return false;
            }
            
            // ✅ ИСПРАВЛЕНО: PRICE FILTER (цена) - добавлена отладка и правильная фильтрация
            if (priceFrom > 0 || priceTo > 0) {
                const priceInMillions = parseFloat(property.price) / 1000000;
                
                if (priceFrom > 0 && priceInMillions < priceFrom) {
                    return false;
                }
                if (priceTo > 0 && priceInMillions > priceTo) {
                    return false;
                }
            }
            
            // ✅ ИСПРАВЛЕНО: Completion date filter (фильтр по дате сдачи)
            if (selectedCompletionDates.length > 0) {
                console.log(`Completion filter active:`, selectedCompletionDates);
                console.log(`Property completion_date: "${property.completion_date}"`);
                
                const match = selectedCompletionDates.some(date => {
                    // Сданные объекты
                    if (date === 'Сдан') {
                        return property.completion_date === 'Сдан' || 
                               property.status === 'ready' || 
                               property.completion_date === 'Готов' ||
                               property.completion_date === 'Сдано';
                    }
                    
                    // Годы сдачи (2024, 2025, 2026, 2028)
                    if (date.match(/^\d{4}$/)) {
                        // Проверяем что completion_date содержит год
                        const hasYear = property.completion_date && property.completion_date.includes(date);
                        console.log(`Year ${date} check: "${property.completion_date}" includes "${date}"? ${hasYear}`);
                        return hasYear;
                    }
                    
                    // Точное совпадение
                    return property.completion_date === date;
                });
                
                if (!match) {
                    console.log(`❌ Completion date filter: no match for "${property.completion_date}"`);
                    return false;
                }
                console.log(`✅ Completion date filter: match found!`);
            }
            
            // ADVANCED FILTERS from "Еще" section
            
            // Area filter (площадь)
            if (areaFrom > 0 || areaTo > 0) {
                const area = parseFloat(property.area || 0);
                if (areaFrom > 0 && area < areaFrom) return false;
                if (areaTo > 0 && area > areaTo) return false;
            }
            
            // Floor filter (этаж) - фильтр по этажу КВАРТИРЫ
            if (floorFrom > 0 || floorTo > 0) {
                const minFloor = parseInt(property.object_min_floor || property.floor || 0);
                const maxFloor = parseInt(property.object_max_floor || property.total_floors || minFloor);
                
                // ВАЖНО: фильтруем по этажу КВАРТИРЫ, не здания
                // Если указано "до 3 этажа" - показываем квартиры на 1-3 этажах
                if (floorFrom > 0 && minFloor < floorFrom) return false;
                if (floorTo > 0 && minFloor > floorTo) return false;
            }
            
            // Building floors filter (этажность дома) - по максимальной этажности здания
            if (maxFloorFrom > 0 || maxFloorTo > 0) {
                const buildingMaxFloors = parseInt(property.object_max_floor || property.total_floors || 0);
                if (maxFloorFrom > 0 && buildingMaxFloors < maxFloorFrom) return false;
                if (maxFloorTo > 0 && buildingMaxFloors > maxFloorTo) return false;
            }
            
            // Building floors filter (этажность дома) - используем числовые поля
            if (maxFloorFrom > 0 || maxFloorTo > 0) {
                const buildingFloors = parseInt(property.object_max_floor || property.total_floors || 0);
                if (maxFloorFrom > 0 && buildingFloors < maxFloorFrom) return false;
                if (maxFloorTo > 0 && buildingFloors > maxFloorTo) return false;
            }
            
            // Building status filter (статус сданности) - ИСПРАВЛЕНО: используем правильное поле
            if (selectedBuildingReleased.length > 0) {
                const match = selectedBuildingReleased.some(status => {
                    const buildingReleased = property.complex_building_released; // ПРАВИЛЬНОЕ ПОЛЕ!
                    
                    if (status === 'true') {
                        // Сданный дом - проверяем complex_building_released = True
                        return buildingReleased === true || buildingReleased === 'True' || buildingReleased === 'true';
                    }
                    
                    if (status === 'false') {
                        // В строительстве - проверяем complex_building_released = False
                        return buildingReleased === false || buildingReleased === 'False' || buildingReleased === 'false';
                    }
                    
                    return false;
                });
                if (!match) return false;
            }
            
            // Build year range filter (диапазон года сдачи) - ИСПРАВЛЕНО: используем правильное поле
            const buildYearFrom = document.getElementById('buildYearFrom')?.value;
            const buildYearTo = document.getElementById('buildYearTo')?.value;
            if (buildYearFrom || buildYearTo) {
                const buildingYear = parseInt(property.complex_building_end_build_year || 0); // ПРАВИЛЬНОЕ ПОЛЕ!
                
                if (buildYearFrom && buildingYear < parseInt(buildYearFrom)) return false;
                if (buildYearTo && buildingYear > parseInt(buildYearTo)) return false;
            }
            
            // Developer filter (застройщик) - используем правильное поле из Excel
            if (selectedDevelopers.length > 0) {
                const match = selectedDevelopers.some(developer => {
                    return property.developer_name === developer || 
                           property.developer === developer;
                });
                if (!match) return false;
            }
            
            // Complex filter (жилой комплекс) - новый фильтр для параметра complex=
            // ✅ ИСПРАВЛЕНО: Проверяем что фильтр активен И не null/не пустой
            if (activeFilters.residential_complex && activeFilters.residential_complex !== null && activeFilters.residential_complex !== '' && activeFilters.residential_complex !== 'null') {
                const complexName = activeFilters.residential_complex;
                
                // Debug: показываем что ищем и что сравниваем
                console.log(`🏠 Complex filter: looking for "${complexName}"`);
                console.log(`🔍 Property complex_name: "${property.complex_name}"`);
                
                // Более гибкое сравнение - учитываем разные варианты
                const match = property.complex_name === complexName || 
                             property.residential_complex === complexName ||
                             property.complex === complexName ||
                             // Дополнительные проверки для обработки кавычек
                             (property.complex_name && property.complex_name.includes(complexName.replace(/"/g, ''))) ||
                             (complexName.includes(property.complex_name));
                             
                if (!match) {
                    console.log(`❌ Complex filter: "${complexName}" not found in "${property.complex_name}"`);
                    return false;
                }
                console.log(`✅ Complex filter: match found!`);
            } else if (activeFilters.residential_complex === null || activeFilters.residential_complex === 'null') {
                // ✅ ДОБАВЛЕНО: Логирование когда фильтр сброшен
                console.log('🔄 Complex filter is NULL/cleared - showing all properties');
            }
            
            // District filter (район)
            if (selectedDistricts.length > 0) {
                const match = selectedDistricts.some(district => {
                    return property.district === district || 
                           property.address_locality_name === district;
                });
                if (!match) return false;
            }
            
            // Region filter (регион)
            if (selectedRegions.length > 0) {
                const match = selectedRegions.some(region => {
                    return property.parsed_region === region || 
                           property.region_name === region || 
                           property.region === region;
                });
                if (!match) return false;
            }
            
            // City filter (город) - ищем в полном адресе
            if (selectedCities.length > 0) {
                const match = selectedCities.some(city => {
                    const fullAddress = (property.address || property.address_display_name || '').toLowerCase();
                    return fullAddress.includes(city.toLowerCase());
                });
                if (!match) return false;
            }
            
            // Features filter (особенности)
            if (selectedFeatures.length > 0) {
                // Словарь сопоставления английских и русских названий особенностей
                const featureMapping = {
                    'accreditation': 'Аккредитация',
                    'green_mortgage': 'Зеленая ипотека',
                    'ready': 'Сдан',
                    'under_construction': 'В строительстве',
                    'no_finish': 'Без отделки',
                    'with_finish': 'С отделкой'
                };
                
                const match = selectedFeatures.some(feature => {
                    const russianFeature = featureMapping[feature] || feature;
                    
                    // Проверяем различные поля с особенностями
                    return (property.features && property.features.includes(russianFeature)) ||
                           (property.amenities && property.amenities.includes(russianFeature)) ||
                           (property.description && property.description.includes(russianFeature)) ||
                           // Дополнительные проверки для зеленой ипотеки
                           (feature === 'green_mortgage' && (property.has_green_mortgage || property.green_mortgage)) ||
                           // Проверки для аккредитации
                           (feature === 'accreditation' && property.building_accreditation);
                });
                if (!match) return false;
            }
            
            // Renovation filter (отделка)
            if (selectedRenovationTypes.length > 0) {
                const match = selectedRenovationTypes.some(renovationType => {
                    const propertyRenovation = property.renovation_display_name || property.renovation_type || property.renovation || '';
                    return propertyRenovation.toLowerCase().includes(renovationType.toLowerCase()) ||
                           propertyRenovation === renovationType;
                });
                if (!match) return false;
            }
            
            // Object class filter (класс жилья)
            if (selectedObjectClasses.length > 0) {
                console.log('Object class filter active with:', selectedObjectClasses);
                const propertyClass = property.complex_object_class_display_name || property.object_class || property.property_class || property.class || '';
                console.log(`Property class field: "${propertyClass}" (property id: ${property.id})`);
                
                const match = selectedObjectClasses.some(objClass => {
                    const matches = propertyClass.toLowerCase().includes(objClass.toLowerCase()) || 
                                  propertyClass === objClass ||
                                  property.object_class === objClass || 
                                  property.property_class === objClass ||
                                  property.class === objClass;
                    return matches;
                });
                
                if (match) {
                    console.log(`✅ Object class MATCH for property ${property.id}: "${propertyClass}"`);
                } else {
                    console.log(`❌ Object class NO MATCH for property ${property.id}: "${propertyClass}" vs [${selectedObjectClasses.join(', ')}]`);
                }
                
                if (!match) return false;
            }
            
            // Advanced filters integration
            // District filter (from advanced filters)
            if (advancedFilters.districts && advancedFilters.districts.length > 0) {
                const match = advancedFilters.districts.some(district => {
                    return property.district === district;
                });
                if (!match) return false;
            }
            
            // Developer filter (from advanced filters)
            if (advancedFilters.developers && advancedFilters.developers.length > 0) {
                const match = advancedFilters.developers.some(developer => {
                    return property.developer === developer;
                });
                if (!match) return false;
            }
            
            // Property type filter (from advanced filters)
            if (advancedFilters.propertyTypes && advancedFilters.propertyTypes.length > 0) {
                const match = advancedFilters.propertyTypes.some(type => {
                    return property.type === type || property.property_type === type;
                });
                if (!match) return false;
            }
            
            // Area filter (from advanced filters)
            if (advancedFilters.areas && advancedFilters.areas.length > 0) {
                const match = advancedFilters.areas.some(areaRange => {
                    const area = parseFloat(property.area);
                    if (areaRange === '30-50') return area >= 30 && area <= 50;
                    if (areaRange === '50-70') return area >= 50 && area <= 70;
                    if (areaRange === '70-100') return area >= 70 && area <= 100;
                    if (areaRange === '100+') return area > 100;
                    return false;
                });
                if (!match) return false;
            }
            
            // Area range filter (from advanced filters)
            if (advancedFilters.areaFrom > 0 || advancedFilters.areaTo > 0) {
                const area = parseFloat(property.area);
                if (advancedFilters.areaFrom > 0 && area < advancedFilters.areaFrom) return false;
                if (advancedFilters.areaTo > 0 && area > advancedFilters.areaTo) return false;
            }
            
            // Distance filter (from advanced filters)
            if (advancedFilters.distances && advancedFilters.distances.length > 0) {
                const match = advancedFilters.distances.some(distanceRange => {
                    // Mock distance calculation - in real app would be calculated from coordinates
                    const mockDistance = Math.random() * 20; // 0-20 km
                    if (distanceRange === '0-5') return mockDistance <= 5;
                    if (distanceRange === '5-10') return mockDistance > 5 && mockDistance <= 10;
                    if (distanceRange === '10-15') return mockDistance > 10 && mockDistance <= 15;
                    if (distanceRange === '15+') return mockDistance > 15;
                    return false;
                });
                if (!match) return false;
            }
            
            // Payment methods filter (from advanced filters)
            if (advancedFilters.payments && advancedFilters.payments.length > 0) {
                // Mock payment methods - in real app would check property payment options
                const match = advancedFilters.payments.some(payment => {
                    return true; // All properties support all payment methods for now
                });
                if (!match) return false;
            }
            
            // Direction filter (from advanced filters)
            if (advancedFilters.directions && advancedFilters.directions.length > 0) {
                // Mock direction - in real app would check property orientation
                const directions = ['север', 'юг', 'восток', 'запад', 'юго-восток', 'юго-запад', 'северо-восток', 'северо-запад'];
                const propertyDirection = directions[property.id % directions.length];
                const match = advancedFilters.directions.includes(propertyDirection);
                if (!match) return false;
            }
            

            
            return true;
        });
        
        console.log(`🎯 FILTERING RESULT: ${filteredProperties.length} properties from ${allProperties.length} total`);
        
        // Store globally for other functions
        window.filteredProperties = filteredProperties;
        
        // ✅ КРИТИЧЕСКИ ВАЖНО: Обновляем счетчик СРАЗУ после фильтрации
        console.log(`🔄 Calling updateResultsCount with: ${filteredProperties.length}`);
        updateResultsCount(filteredProperties.length);
        
        // ✅ НЕ ВЫЗЫВАЕМ updatePropertiesList здесь - это делается ниже с пагинацией
        currentPage = 1; // Reset to first page when filtering
        
        // ✅ КРИТИЧЕСКИ ИСПРАВЛЕНО: Пагинация - показываем ТОЛЬКО текущую страницу
        const totalPages = Math.ceil(filteredProperties.length / window.itemsPerPage);
        
        // ВАЖНО: Показываем только объекты текущей страницы
        const startIndex = (currentPage - 1) * window.itemsPerPage;
        const endIndex = startIndex + window.itemsPerPage;
        const pageProperties = filteredProperties.slice(startIndex, endIndex);
        
        console.log(`📄 Пагинация: страница ${currentPage}/${totalPages}, показываем ${pageProperties.length} объектов (${startIndex+1}-${Math.min(endIndex, filteredProperties.length)} из ${filteredProperties.length})`);
        
        // КРИТИЧНО: Передаем только объекты текущей страницы, НЕ все filtered
        updatePropertiesList(pageProperties);
        
        // Показываем пагинацию только если больше 1 страницы
        if (totalPages > 1) {
            updatePaginationControls(filteredProperties.length, totalPages);
        } else {
            // Скрываем пагинацию если только 1 страница
            const paginationContainer = document.getElementById('pagination-container');
            if (paginationContainer) paginationContainer.innerHTML = '';
        }
        
        // ✅ ДОБАВЛЕНО: Update active filters display
        displayActiveFilters();
        
        // Initialize buttons after filtering
        setTimeout(() => {
            initializeAllButtons();
            console.log('Buttons reinitialized after filtering');
        }, 50);
        
    } finally {
        window.isFiltering = false;
    }
}

// ✅ КРИТИЧЕСКИ ИСПРАВЛЕНО: Update results counter - НАХОДИМ ЛЮБОЙ H3 с "Найдено"
function updateResultsCount(count) {
    // ✅ SERVER-SIDE MODE: Use server's total count
    if (window.serverSidePagination && window.totalProperties !== undefined) {
        count = window.totalProperties;
        console.log(`🌐 Using server-side count: ${count}`);
    } else {
        console.log(`🔄 updateResultsCount called with count: ${count}`);
    }
    
    // Функция склонения слова "объект"  
    function getObjectWord(count) {
        if (count % 100 >= 11 && count % 100 <= 14) return "объектов";
        switch (count % 10) {
            case 1: return "объект";
            case 2: case 3: case 4: return "объекта";
            default: return "объектов";
        }
    }
    
    // СТРАТЕГИЯ 1: Ищем любой H3 который содержит текст "Найдено"
    const h3Elements = document.querySelectorAll('h3');
    let targetH3 = null;
    
    for (let h3 of h3Elements) {
        if (h3.textContent && h3.textContent.includes('Найдено')) {
            targetH3 = h3;
            break;
        }
    }
    
    if (targetH3) {
        // Полностью перезаписываем содержимое H3
        targetH3.innerHTML = `Найдено <span id="results-count">${count}</span> ${getObjectWord(count)}`;
        console.log(`✅ Обновлен H3 с "Найдено": ${count} ${getObjectWord(count)}`);
        return;
    }
    
    // СТРАТЕГИЯ 2: Если H3 не найден, ищем span results-count
    const resultsCount = document.getElementById('results-count');
    if (resultsCount) {
        resultsCount.textContent = count;
        console.log(`✅ Обновлен span results-count: ${count}`);
        return;
    }
    
    // СТРАТЕГИЯ 3: Если ничего не найдено, создаем новый элемент
    console.error(`❌ НЕ НАЙДЕН элемент для обновления счетчика! Создаем новый...`);
    
    // Ищем контейнер результатов
    const resultsSection = document.querySelector('.bg-white.rounded-xl.shadow-sm.border.border-gray-200.p-4');
    if (resultsSection) {
        const newH3 = document.createElement('h3');
        newH3.className = 'text-xl font-bold text-gray-900';
        newH3.innerHTML = `Найдено <span id="results-count">${count}</span> ${getObjectWord(count)}`;
        resultsSection.insertBefore(newH3, resultsSection.firstChild);
        console.log(`✅ Создан новый H3: ${count} ${getObjectWord(count)}`);
        return;
    }
    
    console.error('❌ Критическая ошибка: не удалось найти или создать элемент счетчика!');
}

// ОТКЛЮЧЕНО: JavaScript пагинация (теперь используется серверная пагинация)
function updatePaginationControls(totalItems, totalPages) {
    // Пустая функция - JavaScript пагинация отключена, используется серверная
    console.log('⚠️ JavaScript pagination disabled - using server-side pagination');
    return;
}

// ✅ ИСПРАВЛЕНО: Go to specific page - правильная пагинация
function goToPage(page) {
    const dataToUse = window.filteredProperties && window.filteredProperties.length > 0 ? window.filteredProperties : allProperties;
    const totalPages = Math.ceil(dataToUse.length / window.itemsPerPage);
    
    if (page < 1 || page > totalPages) {
        console.log(`❌ Неверная страница: ${page}, доступно: 1-${totalPages}`);
        return;
    }
    
    console.log(`📄 Переход на страницу ${page} из ${totalPages}`);
    
    currentPage = page;
    
    // Показываем только объекты текущей страницы
    const startIndex = (currentPage - 1) * window.itemsPerPage;
    const endIndex = startIndex + window.itemsPerPage;
    const pageProperties = dataToUse.slice(startIndex, endIndex);
    
    console.log(`📄 Показываем объекты ${startIndex+1}-${Math.min(endIndex, dataToUse.length)} из ${dataToUse.length}`);
    
    // Обновляем список с объектами ТОЛЬКО текущей страницы
    updatePropertiesList(pageProperties);
    
    // Обновляем пагинацию для выделения текущей страницы
    updatePaginationControls(dataToUse.length, totalPages);
    
    // Прокрутка к началу списка объектов
    const propertiesContainer = document.getElementById('properties-container');
    if (propertiesContainer) {
        propertiesContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
    } else {
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }
}

// Advanced Filters Functions
// advancedFilters already declared above

function applyAdvancedFilters() {
    console.log('Applying advanced filters...');
    
    // Collect all advanced filter values
    advancedFilters.districts = Array.from(document.querySelectorAll('input[data-filter="district"]:checked')).map(cb => cb.value);
    advancedFilters.developers = Array.from(document.querySelectorAll('input[data-filter="developer"]:checked')).map(cb => cb.value);
    advancedFilters.propertyTypes = Array.from(document.querySelectorAll('input[data-filter="propertyType"]:checked')).map(cb => cb.value);
    advancedFilters.roomTypes = Array.from(document.querySelectorAll('#advancedFiltersSection input[data-filter="rooms"]:checked')).map(cb => cb.value);
    
    // Update the quick filters to match advanced filters
    if (advancedFilters.districts.length > 0) {
        // Update district dropdown if exists
        const districtSelect = document.querySelector('select[name="district"]');
        if (districtSelect) {
            districtSelect.value = advancedFilters.districts[0];
        }
    }
    
    // Apply the unified filter logic
    filterProperties();
    
    // Update results count in advanced filters
    updateAdvancedFiltersResultsCount();
    
    // Hide advanced filters panel
    toggleAdvancedFilters();
}

function clearAllAdvancedFilters() {
    console.log('Clearing all advanced filters...');
    
    // Clear all checkboxes in advanced filters
    document.querySelectorAll('#advancedFiltersSection input[type="checkbox"]').forEach(cb => {
        cb.checked = false;
    });
    
    // Reset advanced filters object
    advancedFilters = {
        districts: [],
        developers: [],
        propertyTypes: [],
        priceMin: 0,
        priceMax: 0,
        roomTypes: [],
        distances: [],
        areas: [],
        directions: [],
        payments: [],
        areaFrom: 0,
        areaTo: 0
    };
    
    // Clear main filter checkboxes too
    document.querySelectorAll('input[data-filter-type="rooms"]:checked').forEach(checkbox => {
        checkbox.checked = false;
    });
    
    // Update results display
    filterProperties();
    
    // Update results count in advanced filters
    updateAdvancedFiltersResultsCount();
}

function updateAdvancedFiltersResultsCount() {
    const resultCountElement = document.getElementById('advancedResultsCount');
    if (resultCountElement) {
        const count = filteredProperties.length || allProperties.length;
        resultCountElement.textContent = `${count} квартир найдено`;
    }
}

// Save current filters function
function saveCurrentFilters() {
    console.log('Saving current filters state...');
    toggleAdvancedFilters(); // Just close the panel for now
}

// Initialize advanced filters dropdowns
function initializeAdvancedFilters() {
    // Handle dropdown toggle for advanced filters
    document.querySelectorAll('#advancedFiltersSection .filter-option-btn').forEach(button => {
        button.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            const dropdown = this.closest('.filter-dropdown');
            if (!dropdown) return;
            
            const menu = dropdown.querySelector('.dropdown-menu');
            if (!menu) return;
            
            // Close other dropdowns
            document.querySelectorAll('#advancedFiltersSection .dropdown-menu').forEach(otherMenu => {
                if (otherMenu !== menu) {
                    otherMenu.classList.add('hidden');
                }
            });
            
            // Toggle current dropdown
            menu.classList.toggle('hidden');
            console.log('Advanced dropdown toggled');
        });
    });
    
    // Handle checkbox changes in advanced filters - AJAX MODE
    document.querySelectorAll('#advancedFiltersSection input[type="checkbox"]').forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            console.log('✅ Advanced filter checkbox changed (AJAX MODE):', this.value, this.checked);
            
            // ✅ НОВОЕ: Используем AJAX фильтрацию вместо клиентской
            if (typeof window.applyFilters === 'function') {
                window.applyFilters();
            } else {
                console.warn('⚠️ window.applyFilters not available yet, using fallback');
            }
            
            // Update active filters display
            if (typeof window.displayActiveFilters === 'function') {
                window.displayActiveFilters();
            }
            
            // Real-time update of filter count
            updateAdvancedFiltersResultsCount();
            
            // Initialize buttons after filtering
            setTimeout(() => {
                initializeAllButtons();
                console.log('Buttons reinitialized after advanced filtering');
            }, 50);
        });
    });
    
    // Close dropdowns when clicking outside
    document.addEventListener('click', function(e) {
        if (!e.target.closest('#advancedFiltersSection .filter-dropdown')) {
            document.querySelectorAll('#advancedFiltersSection .dropdown-menu').forEach(menu => {
                menu.classList.add('hidden');
            });
        }
    });
}

// Display active filters

// Remove individual filter
function removeFilter(type, value) {
    if (type === 'rooms') {
        const checkbox = document.querySelector(`input[data-filter-type="rooms"][value="${value}"]`);
        if (checkbox) checkbox.checked = false;
        handleRoomFilterChange();
    } else if (type === 'price') {
        document.getElementById('priceFrom').value = '';
        document.getElementById('priceTo').value = '';
        document.getElementById('priceFilterText').textContent = 'Цена от-до, ₽';
    } else if (type === 'completion') {
        const checkbox = document.querySelector(`input[data-filter-type="completion"][value="${value}"]`);
        if (checkbox) checkbox.checked = false;
    } else if (type === 'distance') {
        const checkbox = document.querySelector(`input[data-filter="distance"][value="${value}"]`);
        if (checkbox) checkbox.checked = false;
    } else if (type === 'area') {
        const checkbox = document.querySelector(`input[data-filter="area"][value="${value}"]`);
        if (checkbox) checkbox.checked = false;
    } else if (type === 'areaRange') {
        const areaFrom = document.getElementById('areaFrom');
        const areaTo = document.getElementById('areaTo');
        if (areaFrom) areaFrom.value = '';
        if (areaTo) areaTo.value = '';
    } else if (type === 'direction') {
        const checkbox = document.querySelector(`input[data-filter="direction"][value="${value}"]`);
        if (checkbox) checkbox.checked = false;
    } else if (type === 'payment') {
        const checkbox = document.querySelector(`input[data-filter="payment"][value="${value}"]`);
        if (checkbox) checkbox.checked = false;
    } else if (type === 'district') {
        const checkbox = document.querySelector(`input[data-filter="district"][value="${value}"]`);
        if (checkbox) checkbox.checked = false;
    } else if (type === 'developer') {
        const checkbox = document.querySelector(`input[data-filter="developer"][value="${value}"]`);
        if (checkbox) checkbox.checked = false;
    } else if (type === 'propertyType') {
        const checkbox = document.querySelector(`input[data-filter="propertyType"][value="${value}"]`);
        if (checkbox) checkbox.checked = false;
    } else if (type === 'advancedRooms') {
        const checkbox = document.querySelector(`#advancedFiltersSection input[data-filter="rooms"][value="${value}"]`);
        if (checkbox) checkbox.checked = false;
    } else if (type === 'propertyClass') {
        const checkbox = document.querySelector(`input[data-filter="property_class"][value="${value}"]`);
        if (checkbox) checkbox.checked = false;
    } else if (type === 'wallMaterial') {
        const checkbox = document.querySelector(`input[data-filter="wall_material"][value="${value}"]`);
        if (checkbox) checkbox.checked = false;
    } else if (type === 'floorsTotal') {
        const checkbox = document.querySelector(`input[data-filter="floors_total"][value="${value}"]`);
        if (checkbox) checkbox.checked = false;
    } else if (type === 'propertyType2') {
        const checkbox = document.querySelector(`input[data-filter="property_type"][value="${value}"]`);
        if (checkbox) checkbox.checked = false;
    } else if (type === 'salesStart') {
        const checkbox = document.querySelector(`input[data-filter="sales_start"][value="${value}"]`);
        if (checkbox) checkbox.checked = false;
    } else if (type === 'parking') {
        const checkbox = document.querySelector(`input[data-filter="parking"][value="${value}"]`);
        if (checkbox) checkbox.checked = false;
    } else if (type === 'elevator') {
        const checkbox = document.querySelector(`input[data-filter="elevator"][value="${value}"]`);
        if (checkbox) checkbox.checked = false;
    } else if (type === 'registration') {
        const checkbox = document.querySelector(`input[data-filter="registration"][value="${value}"]`);
        if (checkbox) checkbox.checked = false;
    } else if (type === 'nearbyPlaces') {
        const checkbox = document.querySelector(`input[data-filter="nearby_places"][value="${value}"]`);
        if (checkbox) checkbox.checked = false;
    } else if (type === 'windowView') {
        const checkbox = document.querySelector(`input[data-filter="window_view"][value="${value}"]`);
        if (checkbox) checkbox.checked = false;
    } else if (type === 'specialApartments') {
        const checkbox = document.querySelector(`input[data-filter="special_apartments"][value="${value}"]`);
        if (checkbox) checkbox.checked = false;
    } else if (type === 'dropdownDeveloper') {
        const dropdown = document.getElementById('developer-filter');
        if (dropdown) dropdown.value = '';
    } else if (type === 'dropdownDistrict') {
        const dropdown = document.getElementById('district-filter');
        if (dropdown) dropdown.value = '';
    } else if (type === 'worldSides') {
        const checkbox = document.querySelector(`input[data-filter="world_sides"][value="${value}"]`);
        if (checkbox) checkbox.checked = false;
    } else if (type === 'region') {
        const checkbox = document.querySelector(`input[data-filter-type="region"][value="${value}"]`);
        if (checkbox) checkbox.checked = false;
        handleRegionFilterChange();
    } else if (type === 'city') {
        const checkbox = document.querySelector(`input[data-filter-type="city"][value="${value}"]`);
        if (checkbox) checkbox.checked = false;
        handleCityFilterChange();
    }
    
    // Update advanced filters object (excluding duplicates from quick filters)
    advancedFilters.developers = Array.from(document.querySelectorAll('input[data-filter="developer"]:checked')).map(cb => cb.value);
    advancedFilters.propertyTypes = Array.from(document.querySelectorAll('input[data-filter="propertyType"]:checked')).map(cb => cb.value);
    advancedFilters.distances = Array.from(document.querySelectorAll('input[data-filter="distance"]:checked')).map(cb => cb.value);
    advancedFilters.areas = Array.from(document.querySelectorAll('input[data-filter="area"]:checked')).map(cb => cb.value);
    advancedFilters.directions = Array.from(document.querySelectorAll('input[data-filter="direction"]:checked')).map(cb => cb.value);
    
    // New advanced filters - add to activeFilters too
    advancedFilters.propertyClass = Array.from(document.querySelectorAll('input[data-filter="property_class"]:checked')).map(cb => cb.value);
    advancedFilters.wallMaterial = Array.from(document.querySelectorAll('input[data-filter="wall_material"]:checked')).map(cb => cb.value);
    advancedFilters.floorsTotal = Array.from(document.querySelectorAll('input[data-filter="floors_total"]:checked')).map(cb => cb.value);
    advancedFilters.propertyType = Array.from(document.querySelectorAll('input[data-filter="property_type"]:checked')).map(cb => cb.value);
    advancedFilters.salesStart = Array.from(document.querySelectorAll('input[data-filter="sales_start"]:checked')).map(cb => cb.value);
    advancedFilters.parking = Array.from(document.querySelectorAll('input[data-filter="parking"]:checked')).map(cb => cb.value);
    advancedFilters.elevator = Array.from(document.querySelectorAll('input[data-filter="elevator"]:checked')).map(cb => cb.value);
    advancedFilters.registration = Array.from(document.querySelectorAll('input[data-filter="registration"]:checked')).map(cb => cb.value);
    advancedFilters.nearbyPlaces = Array.from(document.querySelectorAll('input[data-filter="nearby_places"]:checked')).map(cb => cb.value);
    advancedFilters.windowView = Array.from(document.querySelectorAll('input[data-filter="window_view"]:checked')).map(cb => cb.value);
    advancedFilters.specialApartments = Array.from(document.querySelectorAll('input[data-filter="special_apartments"]:checked')).map(cb => cb.value);
    advancedFilters.worldSides = Array.from(document.querySelectorAll('input[data-filter="world_sides"]:checked')).map(cb => cb.value);
    
    // Update activeFilters with all new advanced filters
    activeFilters.propertyClass = advancedFilters.propertyClass;
    activeFilters.wallMaterial = advancedFilters.wallMaterial;
    activeFilters.floorsTotal = advancedFilters.floorsTotal;
    activeFilters.propertyType = advancedFilters.propertyType;
    activeFilters.salesStart = advancedFilters.salesStart;
    activeFilters.parking = advancedFilters.parking;
    activeFilters.elevator = advancedFilters.elevator;
    activeFilters.registration = advancedFilters.registration;
    activeFilters.nearbyPlaces = advancedFilters.nearbyPlaces;
    activeFilters.windowView = advancedFilters.windowView;
    activeFilters.specialApartments = advancedFilters.specialApartments;
    activeFilters.worldSides = advancedFilters.worldSides;
    advancedFilters.payments = Array.from(document.querySelectorAll('input[data-filter="payment"]:checked')).map(cb => cb.value);
    
    // Update area range
    const areaFromValue = document.getElementById('areaFrom')?.value;
    const areaToValue = document.getElementById('areaTo')?.value;
    advancedFilters.areaFrom = parseFloat(areaFromValue) || 0;
    advancedFilters.areaTo = parseFloat(areaToValue) || 0;
    
    filterProperties();
    displayActiveFilters();
}

// View switching functions
function switchToListView() {
    document.getElementById('listViewBtn').classList.add('bg-[#0088CC]', 'text-white');
    document.getElementById('gridViewBtn').classList.remove('bg-[#0088CC]', 'text-white');
    
    const container = document.getElementById('propertiesList');
    if (container) {
        container.className = 'space-y-6';
        // ✅ ИСПРАВЛЕНО: Используем текущие отфильтрованные данные с пагинацией
        const dataToUse = window.filteredProperties && window.filteredProperties.length > 0 ? window.filteredProperties : allProperties;
        
        const startIndex = (currentPage - 1) * window.itemsPerPage;
        const pageProperties = dataToUse.slice(startIndex, startIndex + window.itemsPerPage);
        updatePropertiesList(pageProperties);
    }
}

function switchToGridView() {
    document.getElementById('gridViewBtn').classList.add('bg-[#0088CC]', 'text-white');
    document.getElementById('listViewBtn').classList.remove('bg-[#0088CC]', 'text-white');
    
    const container = document.getElementById('propertiesList');
    if (container) {
        container.className = 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6';
        // ✅ ИСПРАВЛЕНО: Используем текущие отфильтрованные данные с пагинацией
        const dataToUse = window.filteredProperties && window.filteredProperties.length > 0 ? window.filteredProperties : allProperties;
        
        const startIndex = (currentPage - 1) * window.itemsPerPage;
        const pageProperties = dataToUse.slice(startIndex, startIndex + window.itemsPerPage);
        updatePropertiesList(pageProperties);
    }
}

function switchToMapView() {
    alert('Карта в разработке');
}

// ✅ УДАЛЕНА: Вторая дублирующая функция

// Initialize everything on page load
document.addEventListener('DOMContentLoaded', function() {
    // ✅ ИСПРАВЛЕНО: Вызываем мою переименованную функцию
    initializeClearAllButton();
    initializeAdvancedFilters();
    initializeDropdownFilters();
    
    // ✅ ИСПРАВЛЕНИЕ: Используем глобальную функцию для инициализации carousel
    if (typeof window.initializeImageCarousels === 'function') {
        window.initializeImageCarousels();
    }
    
    // Add event listeners for main filter dropdowns to show active filters
    const developerFilter = document.getElementById('developer-filter');
    if (developerFilter) {
        developerFilter.addEventListener('change', function() {
            filterProperties();
            displayActiveFilters();
        });
    }
    
    const districtFilter = document.getElementById('district-filter');
    if (districtFilter) {
        districtFilter.addEventListener('change', function() {
            filterProperties();
            displayActiveFilters();
        });
    }
    
    // Initialize NEW filter dropdowns (registration, nearby places, etc.)
    const filterDropdowns = document.querySelectorAll('.filter-dropdown');
    console.log('Found filter dropdowns:', filterDropdowns.length, filterDropdowns);
    filterDropdowns.forEach(dropdown => {
        const btn = dropdown.querySelector('.dropdown-btn');
        const menu = dropdown.querySelector('.dropdown-menu');
        const arrow = dropdown.querySelector('.dropdown-arrow');
        
        if (btn && menu) {
            btn.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                
                // Close other filter dropdowns
                filterDropdowns.forEach(otherDropdown => {
                    if (otherDropdown !== dropdown) {
                        const otherMenu = otherDropdown.querySelector('.dropdown-menu');
                        const otherArrow = otherDropdown.querySelector('.dropdown-arrow');
                        if (otherMenu) {
                            otherMenu.classList.remove('open');
                            otherMenu.classList.add('hidden');
                        }
                        if (otherArrow) otherArrow.style.transform = 'rotate(0deg)';
                    }
                });
                
                // Toggle current dropdown
                const isOpen = menu.classList.contains('open');
                if (isOpen) {
                    menu.classList.remove('open');
                    menu.classList.add('hidden');
                    if (arrow) arrow.style.transform = 'rotate(0deg)';
                } else {
                    menu.classList.add('open');
                    menu.classList.remove('hidden');
                    if (arrow) arrow.style.transform = 'rotate(180deg)';
                }
                
                console.log('Filter dropdown toggled:', dropdown);
                
                // Show dropdown options when opened  
                if (!isOpen) {
                    console.log('Dropdown opened');
                    // Determine filter type from existing checkboxes or button text
                    let filterType = menu.querySelector('input[data-filter]')?.getAttribute('data-filter');
                    
                    if (!filterType) {
                        // If no existing checkboxes, determine from button text
                        const buttonText = btn.textContent.trim();
                        if (buttonText.includes('Прописка')) filterType = 'registration';
                        else if (buttonText.includes('Места рядом')) filterType = 'nearby_places';
                        else if (buttonText.includes('Вид из окон')) filterType = 'window_view';
                        else if (buttonText.includes('Видовые квартиры')) filterType = 'special_apartments';
                        else if (buttonText.includes('Стороны света')) filterType = 'world_sides';
                    }
                    
                    if (filterType) {
                        console.log('Filter type detected:', filterType);
                        showDropdownOptions(menu, filterType);
                    }
                } else {
                    console.log('Dropdown closed');
                }
            });
        }
    });
    
    // Close dropdowns when clicking outside
    document.addEventListener('click', function(e) {
        if (!e.target.closest('.filter-dropdown')) {
            filterDropdowns.forEach(dropdown => {
                const menu = dropdown.querySelector('.dropdown-menu');
                const arrow = dropdown.querySelector('.dropdown-arrow');
                if (menu) {
                    menu.classList.remove('open');
                    menu.classList.add('hidden');
                }
                if (arrow) arrow.style.transform = 'rotate(0deg)';
            });
        }
    });
    
    // Initialize favorite and comparison buttons
    setTimeout(() => {
        initializeAllButtons();
        // Initialize ComparisonManager (loads from database for managers)
        if (window.ComparisonManager && window.ComparisonManager.init) {
            window.ComparisonManager.init();
        }
        // Favorites counter now handled by FavoritesManager
        console.log('Initial page setup complete with favorites and comparison');
    }, 100);
    
    // Initialize view mode to list by default
    const container = document.getElementById('properties-container');
    if (container && !container.getAttribute('data-view-mode')) {
        container.setAttribute('data-view-mode', 'list');
    }
    
    console.log('Dropdown filters initialized, including', filterDropdowns.length, 'new filter dropdowns');
    
    // Function to show dropdown options for new filters
    function showDropdownOptions(menu, filterType) {
        console.log('Showing options for filter:', filterType);
        const existingOptions = menu.querySelectorAll('input[type="checkbox"]');
        
        // If options already exist, don't duplicate
        if (existingOptions.length > 0) {
            console.log('Options already exist for', filterType);
            return;
        }
        
        let options = [];
        
        // Define options for each filter type
        switch(filterType) {
            case 'registration':
                options = ['Возможна', 'Невозможна', 'Временная'];
                break;
            case 'nearby_places':
                options = ['Школа', 'Детский сад', 'Больница', 'Супермаркет', 'Транспорт', 'Парк'];
                break;
            case 'window_view':
                options = ['На двор', 'На улицу', 'На море', 'На горы'];
                break;
            case 'special_apartments':
                options = ['Угловая', 'Пентхаус', 'Двухуровневая', 'С террасой'];
                break;
            case 'world_sides':
                options = ['Север', 'Юг', 'Восток', 'Запад'];
                break;
            default:
                console.log('Unknown filter type:', filterType);
                return;
        }
        
        // Create container for options if it doesn't exist
        let container = menu.querySelector('.p-3.space-y-2');
        if (!container) {
            container = document.createElement('div');
            container.className = 'p-3 space-y-2';
            menu.appendChild(container);
        }
        
        // Clear existing content
        container.innerHTML = '';
        
        // Add options
        options.forEach(option => {
            const label = document.createElement('label');
            label.className = 'flex items-center text-sm hover:bg-gray-50 p-1 rounded cursor-pointer';
            label.innerHTML = `
                <input type="checkbox" class="mr-2 text-[#0088CC]" data-filter="${filterType}" value="${option}" onchange="updateAdvancedFilters()"> ${option}
            `;
            container.appendChild(label);
        });
        
        console.log('Added', options.length, 'options for', filterType);
    }
});

// Check if a specific filter has active values
function checkIfFilterIsActive(dropdown) {
    const filterType = dropdown.getAttribute('data-filter');
    
    switch(filterType) {
        case 'rooms':
            // Check if any room checkboxes are checked
            return dropdown.querySelectorAll('input[type="checkbox"]:checked').length > 0;
            
        case 'price':
            // Check if price inputs have values
            const priceFrom = dropdown.querySelector('#priceFrom');
            const priceTo = dropdown.querySelector('#priceTo');
            return (priceFrom && priceFrom.value) || (priceTo && priceTo.value);
            
        case 'completion':
            // Check if any completion checkboxes are checked
            return dropdown.querySelectorAll('input[type="checkbox"]:checked').length > 0;
            
        default:
            // Generic check for any input with value
            const inputs = dropdown.querySelectorAll('input');
            return Array.from(inputs).some(input => {
                if (input.type === 'checkbox') return input.checked;
                if (input.type === 'text' || input.type === 'number') return input.value;
                return false;
            });
    }
}

// Clear specific filter values via double-click (add separate function)
function clearFilterByDoubleClick(button) {
    const dropdown = button.closest('.filter-dropdown') || button.closest('.dropdown');
    if (!dropdown) return;
    
    const filterType = dropdown.getAttribute('data-filter');
    
    switch(filterType) {
        case 'rooms':
            // Uncheck all room checkboxes
            dropdown.querySelectorAll('input[type="checkbox"]:checked').forEach(cb => cb.checked = false);
            button.textContent = 'Тип квартиры';
            break;
            
        case 'price':
            // Clear price inputs
            const priceFrom = dropdown.querySelector('#priceFrom');
            const priceTo = dropdown.querySelector('#priceTo');
            if (priceFrom) priceFrom.value = '';
            if (priceTo) priceTo.value = '';
            button.textContent = 'Цена от-до, ₽';
            break;
            
        case 'completion':
            // Uncheck all completion checkboxes
            dropdown.querySelectorAll('input[type="checkbox"]:checked').forEach(cb => cb.checked = false);
            button.textContent = 'Срок сдачи';
            break;
    }
    
    // Reapply filters after clearing
    filterProperties();
    console.log('Filter cleared by double-click:', filterType);
}

// Clear specific filter values
function clearSpecificFilter(dropdown) {
    const filterType = dropdown.getAttribute('data-filter');
    
    switch(filterType) {
        case 'rooms':
            // Uncheck all room checkboxes
            dropdown.querySelectorAll('input[type="checkbox"]:checked').forEach(cb => cb.checked = false);
            // Update button text
            const roomsBtn = dropdown.querySelector('.filter-option-btn, .dropdown-btn');
            if (roomsBtn) roomsBtn.textContent = 'Тип квартиры';
            break;
            
        case 'price':
            // Clear price inputs
            const priceFrom = dropdown.querySelector('#priceFrom');
            const priceTo = dropdown.querySelector('#priceTo');
            if (priceFrom) priceFrom.value = '';
            if (priceTo) priceTo.value = '';
            // Update button text
            const priceBtn = dropdown.querySelector('.filter-option-btn, .dropdown-btn');
            if (priceBtn) priceBtn.textContent = 'Цена от-до, ₽';
            break;
            
        case 'completion':
            // Uncheck all completion checkboxes
            dropdown.querySelectorAll('input[type="checkbox"]:checked').forEach(cb => cb.checked = false);
            // Update button text
            const completionBtn = dropdown.querySelector('.filter-option-btn, .dropdown-btn');
            if (completionBtn) completionBtn.textContent = 'Срок сдачи';
            break;
            
        default:
            // Generic clear for all inputs
            dropdown.querySelectorAll('input').forEach(input => {
                if (input.type === 'checkbox') input.checked = false;
                else input.value = '';
            });
            break;
    }
    
    // Reapply filters after clearing
    filterProperties();
}

// Legacy function for backward compatibility 
function initializeFavoriteButtons() {
    initializeAllButtons();
}

// handleFavoriteClick function removed - now handled by FavoritesManager

// Initialize comparison and recommendation buttons only
function initializeAllButtons() {
    // Favorites are now handled by FavoritesManager class
    
    // Clear previous initialization for comparison and recommendation buttons
    document.querySelectorAll('.compare-btn').forEach(btn => {
        if (btn.hasAttribute('data-compare-initialized')) {
            const newBtn = btn.cloneNode(true);
            btn.parentNode.replaceChild(newBtn, btn);
            newBtn.removeAttribute('data-compare-initialized');
        }
    });
    document.querySelectorAll('.recommend-btn').forEach(btn => {
        if (btn.hasAttribute('data-recommend-initialized')) {
            const newBtn = btn.cloneNode(true);
            btn.parentNode.replaceChild(newBtn, btn);
            newBtn.removeAttribute('data-recommend-initialized');
        }
    });
    
    // Favorite buttons are now initialized by FavoritesManager
    // Removed duplicate initialization to prevent conflicts
    
    // Initialize comparison buttons with NEW unified system
    document.querySelectorAll('.compare-btn').forEach(btn => {
        const propertyId = parseInt(btn.getAttribute('data-property-id'));
        
        // Update button state using new system
        if (window.ComparisonManager) {
            window.ComparisonManager.updateButton(propertyId);
        }
        
        // Add event listener if not already added
        if (!btn.hasAttribute('data-compare-initialized')) {
            btn.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                addToCompare(propertyId);
            });
            btn.setAttribute('data-compare-initialized', 'true');
        }
    });
    
    // Initialize recommendation buttons for managers using the new function
    if (window.manager_authenticated) {
        initializeRecommendButtons();
    }
    
    // Clean up old comparison systems and initialize new one
    localStorage.removeItem('propertyComparison'); // Remove old system
    localStorage.removeItem('complexComparison'); // Remove old system
    
    // Initialize comparison counter on page load
    if (window.ComparisonManager) {
        window.ComparisonManager.updateCounters();
    }
    
    console.log('Initialized buttons for', document.querySelectorAll('.property-card').length, 'properties');
}

// Legacy function for backward compatibility
function initializeComparisonButtons() {
    initializeAllButtons();
}

// Legacy toggleFavorite function - now delegates to FavoritesManager
function toggleFavorite(propertyId) {
    if (window.favoritesManager) {
        const heartElement = document.querySelector(`.favorite-heart[data-property-id="${propertyId}"]`);
        window.favoritesManager.toggleFavorite(propertyId, heartElement);
    } else {
        console.error('FavoritesManager not initialized');
    }
}

// NEW UNIFIED COMPARISON SYSTEM
window.ComparisonManager = {
    initialized: false,
    
    // Initialize - load from database for managers
    init: async function() {
        if (this.initialized) return;
        this.initialized = true;
        
        const isManager = Boolean(window.manager_authenticated);
        if (isManager) {
            console.log('🔍 Manager detected - loading comparison from database...');
            await this.loadFromDatabase();
        }
        this.updateCounters();
        this.updateAllButtons();
    },
    
    // Load comparison data from PostgreSQL (managers only)
    loadFromDatabase: async function() {
        const isManager = Boolean(window.manager_authenticated);
        if (!isManager) return;
        
        try {
            const response = await fetch('/api/manager/comparison/load');
            if (response.ok) {
                const result = await response.json();
                console.log('📦 Database comparison data:', result);
                
                if (result.success) {
                    const data = {
                        properties: result.properties || [],
                        complexes: result.complexes || []
                    };
                    localStorage.setItem('comparison-data', JSON.stringify(data));
                    console.log('✅ Loaded from database:', data);
                    this.updateCounters();
                    this.updateAllButtons();
                }
            }
        } catch (error) {
            console.error('❌ Error loading comparison from database:', error);
        }
    },
    
    // Sync to database (managers only)
    syncToDatabase: async function(action, type, id) {
        const isManager = Boolean(window.manager_authenticated);
        if (!isManager) return;
        
        try {
            const endpoint = `/api/manager/comparison/${type}/${action}`;
            const body = type === 'property' ? { property_id: id } : { complex_id: id };
            
            console.log(`📡 Syncing to database: ${action} ${type} ${id}`);
            
            const response = await fetch(endpoint, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(body)
            });
            
            const result = await response.json();
            if (result.success) {
                console.log(`✅ Synced to database: ${action} ${type} ${id}`);
            }
        } catch (error) {
            console.error('❌ Error syncing to database:', error);
        }
    },
    
    // Get current comparison data
    getData: function() {
        return JSON.parse(localStorage.getItem('comparison-data') || '{"properties": [], "complexes": []}');
    },
    
    // Save comparison data
    saveData: function(data) {
        localStorage.setItem('comparison-data', JSON.stringify(data));
        this.updateCounters();
    },
    
    // Add property to comparison
    addProperty: async function(propertyId) {
        const data = this.getData();
        const idStr = propertyId.toString();
        
        if (!data.properties.includes(idStr)) {
            if (data.properties.length >= 4) {
                this.showMessage('Можно сравнивать максимум 4 квартиры', 'warning');
                return false;
            }
            data.properties.push(idStr);
            this.saveData(data);
            this.showMessage('Квартира добавлена в сравнение', 'success');
            console.log('Property added to comparison:', propertyId);
            
            // Sync to database for managers
            await this.syncToDatabase('add', 'property', propertyId);
            
            return true;
        }
        return false;
    },
    
    // Remove property from comparison
    removeProperty: async function(propertyId) {
        const data = this.getData();
        const idStr = propertyId.toString();
        
        if (data.properties.includes(idStr)) {
            data.properties = data.properties.filter(id => id !== idStr);
            this.saveData(data);
            this.showMessage('Квартира удалена из сравнения', 'info');
            console.log('Property removed from comparison:', propertyId);
            
            // Sync to database for managers
            await this.syncToDatabase('remove', 'property', propertyId);
            
            return true;
        }
        return false;
    },
    
    // Check if property is in comparison
    hasProperty: function(propertyId) {
        const data = this.getData();
        return data.properties.includes(propertyId.toString());
    },
    
    // Update all counters
    updateCounters: function() {
        const data = this.getData();
        const totalCount = data.properties.length + data.complexes.length;
        
        // Update global comparison counter in header
        const globalCounter = document.getElementById('comparison-count');
        if (globalCounter) {
            globalCounter.textContent = totalCount;
            globalCounter.style.display = totalCount > 0 ? 'flex' : 'none';
        }
        
        // Update dashboard counters if available
        const propertiesCount = document.getElementById('properties-tab-count');
        if (propertiesCount) {
            propertiesCount.textContent = data.properties.length;
        }
        
        const complexesCount = document.getElementById('complexes-tab-count');
        if (complexesCount) {
            complexesCount.textContent = data.complexes.length;
        }
    },
    
    // Show notification message
    showMessage: function(message, type = 'info') {
        if (typeof showNotification === 'function') {
            showNotification(message, type);
        } else {
            console.log(`[${type}] ${message}`);
        }
    },
    
    // Update button state
    updateButton: function(propertyId) {
        const button = document.querySelector(`[data-property-id="${propertyId}"] .compare-btn, .compare-btn[data-property-id="${propertyId}"]`);
        if (!button) return;
        
        const isInComparison = this.hasProperty(propertyId);
        
        if (isInComparison) {
            button.classList.add('added', 'bg-blue-600', 'text-white');
            button.classList.remove('border-gray-300', 'hover:bg-gray-50', 'text-gray-700');
            button.innerHTML = '<i class="fas fa-check text-xs"></i>';
            button.title = 'Убрать из сравнения';
        } else {
            button.classList.remove('added', 'bg-blue-600', 'text-white');
            button.classList.add('border-gray-300', 'hover:bg-gray-50', 'text-gray-700');
            button.innerHTML = '<i class="fas fa-balance-scale text-xs text-gray-600"></i>';
            button.title = 'Добавить к сравнению';
        }
    },
    
    // Update all comparison buttons on the page
    updateAllButtons: function() {
        const data = this.getData();
        document.querySelectorAll('.compare-btn[data-property-id]').forEach(btn => {
            const propertyId = btn.dataset.propertyId;
            if (propertyId) {
                this.updateButton(propertyId);
            }
        });
        console.log('🔄 Updated all comparison buttons');
    }
};

// Main comparison function
function addToCompare(propertyId) {
    // Prevent rapid clicks
    const button = document.querySelector(`[data-property-id="${propertyId}"] .compare-btn, .compare-btn[data-property-id="${propertyId}"]`);
    if (button && button.disabled) return;
    
    // Temporarily disable button
    if (button) {
        button.disabled = true;
        setTimeout(() => button.disabled = false, 500);
    }
    
    // Toggle comparison state
    if (window.ComparisonManager.hasProperty(propertyId)) {
        window.ComparisonManager.removeProperty(propertyId);
    } else {
        window.ComparisonManager.addProperty(propertyId);
    }
    
    // Update button appearance
    window.ComparisonManager.updateButton(propertyId);
}

// View Mode Toggle Functions
function switchToListView() {
    const container = document.getElementById('properties-container');
    const listBtn = document.querySelector('[data-view="list"]');
    const gridBtn = document.querySelector('[data-view="grid"]');
    
    if (!container || !listBtn || !gridBtn) {
        console.warn('View switching elements not found - list view toggle may not be available');
        return;
    }
    
    // Update container view mode
    container.setAttribute('data-view-mode', 'list');
    
    // Update button styles
    listBtn.className = 'flex items-center gap-1 px-3 py-2 rounded-md text-sm transition-all bg-white shadow-sm text-[#0088CC]';
    gridBtn.className = 'flex items-center gap-1 px-3 py-2 rounded-md text-sm transition-all text-gray-600 hover:text-gray-800';
    
    // ✅ ИСПРАВЛЕНО: Re-render properties with list view - только текущая страница
    const dataToUse = filteredProperties.length > 0 ? filteredProperties : allProperties;
    
    const startIndex = (currentPage - 1) * window.itemsPerPage;
    const pageProperties = dataToUse.slice(startIndex, startIndex + window.itemsPerPage);
    updatePropertiesList(pageProperties);
    console.log('Switched to list view');
}

function switchToGridView() {
    const container = document.getElementById('properties-container');
    const listBtn = document.querySelector('[data-view="list"]');
    const gridBtn = document.querySelector('[data-view="grid"]');
    
    if (!container || !listBtn || !gridBtn) {
        console.warn('View switching elements not found - grid view toggle may not be available');
        return;
    }
    
    // Update container view mode
    container.setAttribute('data-view-mode', 'grid');
    
    // Update button styles
    gridBtn.className = 'flex items-center gap-1 px-3 py-2 rounded-md text-sm transition-all bg-white shadow-sm text-[#0088CC]';
    listBtn.className = 'flex items-center gap-1 px-3 py-2 rounded-md text-sm transition-all text-gray-600 hover:text-gray-800';
    
    // ✅ ИСПРАВЛЕНО: Re-render properties with grid view - только текущая страница  
    const dataToUse = filteredProperties.length > 0 ? filteredProperties : allProperties;
    
    const startIndex = (currentPage - 1) * window.itemsPerPage;
    const pageProperties = dataToUse.slice(startIndex, startIndex + window.itemsPerPage);
    updatePropertiesList(pageProperties);
    console.log('Switched to grid view');
}

</script>

<!-- Favorites system is loaded globally in base.html to prevent duplicates -->

<!-- Presentation Functions - Versioned for cache busting -->
<script src="{{ url_for('static', filename='js/presentation.js') }}?v={{ range(1000, 9999) | random }}"></script>
{% endblock %}

{% block extra_js %}
<!-- ✅ КРИТИЧНО: Установить переменные ДО загрузки property-filters.js -->
<script>
// Server-side pagination flags - MUST be set before property-filters.js loads
window.serverSidePagination = true;
window.totalProperties = {{ total_properties|default(0) }};
window.totalPages = {{ total_pages|default(1) }};
window.currentServerPage = {{ page|default(1) }};

// Developers mapping: ID → Name (для displayActiveFilters)
// Используем строковые ключи, т.к. URL параметры всегда строки
window.developersMap = {
    {% if developers %}
    {% for developer in developers %}
    "{{ developer.id }}": "{{ developer.name|replace('"', '\\"') }}"{% if not loop.last %},{% endif %}
    {% endfor %}
    {% endif %}
};

console.log('✅ Filter variables initialized (before property-filters.js):', {
    serverSidePagination: window.serverSidePagination,
    totalProperties: window.totalProperties,
    totalPages: window.totalPages,
    page: window.currentServerPage,
    developersCount: Object.keys(window.developersMap).length
});

// ✅ View mode switching with localStorage persistence
// Initialize from localStorage or default to 'list'
window.currentViewMode = localStorage.getItem('propertiesViewMode') || 'list';

function switchToListView() {
    window.currentViewMode = 'list';
    localStorage.setItem('propertiesViewMode', 'list');
    const container = document.getElementById('properties-container');
    const listBtn = document.getElementById('list-view-btn');
    const gridBtn = document.getElementById('grid-view-btn');
    
    if (!container) {
        console.error('❌ Container #properties-container not found');
        return;
    }
    
    // Update container classes - LIST MODE
    container.className = 'space-y-6 w-full';
    
    // Update all cards to horizontal layout (flex)
    const cards = container.querySelectorAll('.property-card');
    cards.forEach(card => {
        card.className = 'property-card bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden w-full flex cursor-pointer min-h-[280px]';
        
        // Make image section fixed width - find by carousel container
        const imageSection = card.querySelector('.carousel-container')?.parentElement;
        if (imageSection) {
            imageSection.className = 'relative w-80 h-60 flex-shrink-0 group';
        }
        
        // Content section flex-1 - find by searching for child elements
        const contentSection = card.querySelector('h2')?.closest('div');
        if (contentSection) {
            contentSection.className = 'flex-1 p-6 flex flex-col';
        }
    });
    
    // Update button states
    if (listBtn) {
        listBtn.className = 'flex items-center gap-1 px-3 py-2 rounded-md text-sm font-medium transition-colors bg-white text-gray-900 shadow-sm';
    }
    if (gridBtn) {
        gridBtn.className = 'flex items-center gap-1 px-3 py-2 rounded-md text-sm font-medium transition-colors text-gray-600 hover:text-gray-900';
    }
    
    console.log('✅ Switched to list view');
}

function switchToGridView() {
    window.currentViewMode = 'grid';
    localStorage.setItem('propertiesViewMode', 'grid');
    const container = document.getElementById('properties-container');
    const listBtn = document.getElementById('list-view-btn');
    const gridBtn = document.getElementById('grid-view-btn');
    
    if (!container) {
        console.error('❌ Container #properties-container not found');
        return;
    }
    
    // Update container classes - GRID MODE
    container.className = 'grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 sm:gap-6 w-full';
    
    // Update all cards to vertical layout (flex-col)
    const cards = container.querySelectorAll('.property-card');
    cards.forEach(card => {
        card.className = 'property-card bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden w-full flex flex-col cursor-pointer';
        
        // Make image section full width - find by carousel container
        const imageSection = card.querySelector('.carousel-container')?.parentElement;
        if (imageSection) {
            imageSection.className = 'relative w-full h-48 flex-shrink-0 group';
        }
        
        // Content section normal padding - find by h2
        const contentSection = card.querySelector('h2')?.closest('div');
        if (contentSection) {
            contentSection.className = 'p-4 flex flex-col flex-1';
        }
    });
    
    // Update button states
    if (gridBtn) {
        gridBtn.className = 'flex items-center gap-1 px-3 py-2 rounded-md text-sm font-medium transition-colors bg-white text-gray-900 shadow-sm';
    }
    if (listBtn) {
        listBtn.className = 'flex items-center gap-1 px-3 py-2 rounded-md text-sm font-medium transition-colors text-gray-600 hover:text-gray-900';
    }
    
    console.log('✅ Switched to grid view');
}

// Make functions globally accessible
window.switchToListView = switchToListView;
window.switchToGridView = switchToGridView;

console.log('✅ View switching functions loaded');

// Initialize view on page load from localStorage or default
document.addEventListener('DOMContentLoaded', function() {
    console.log('🔧 Initializing properties page view...');
    console.log('📋 Current view mode:', window.currentViewMode);
    
    // Apply saved view mode or default to list
    if (window.currentViewMode === 'grid') {
        switchToGridView();
    } else {
        switchToListView();
    }
});
</script>
<!-- ✅ ПРИОРИТЕТНАЯ ЗАГРУЗКА: Сортировка должна загрузиться ПЕРВОЙ -->
<script src="{{ url_for('static', filename='js/properties-sorting.js') }}?v=1761507235"></script>
<!-- ✅ AJAX LIST UPDATER: Динамическое обновление списка -->
<script src="{{ url_for('static', filename='js/properties-list-updater.js') }}?v=1761509300"></script>
<!-- ✅ INFINITE SCROLL: Автоматическая подгрузка объектов -->
<script src="{{ url_for('static', filename='js/infinite-scroll.js') }}?v=1761507444"></script>

<script src="{{ url_for('static', filename='js/property-filters.js') }}?v={{ range(1000, 9999) | random }}"></script>
<script src="{{ url_for('static', filename='js/smart_autocomplete.js') }}"></script>
<script src="{{ url_for('static', filename='js/favorites.js') }}"></script>
<script src="{{ url_for('static', filename='js/properties-comparison-fix.js') }}"></script>
<script src="{{ url_for('static', filename='js/properties_mini_map.js') }}"></script>
<script src="{{ url_for('static', filename='js/saved_searches.js') }}?v=1761577011"></script>
<script src="{{ url_for('static', filename='js/property-card-click.js') }}"></script>
<script>
// Initialize SmartAutocomplete for properties search
document.addEventListener('DOMContentLoaded', function() {
    if (typeof SmartAutocomplete !== 'undefined') {
        initializePropertiesSmartSearch();
        console.log('✅ SmartAutocomplete initialized for properties page');
    }
});

// Initialize SavedSearchesManager after the script is loaded
document.addEventListener('DOMContentLoaded', function() {
    if (typeof SavedSearchesManager !== 'undefined') {
        window.savedSearchesManager = new SavedSearchesManager();
        console.log('✅ SavedSearchesManager initialized');
    }
});
</script>
{% endblock %}
